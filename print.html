<!DOCTYPE HTML>
<html lang="fr" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>My legacy</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/catppuccin.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "latte";
            const default_dark_theme = "mocha";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">My legacy</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mon-héritage"><a class="header" href="#mon-héritage">Mon héritage</a></h1>
<p>Ce livre est l'héritage de mes connaissances, en fonction du temps que
j'ai pour l'écrire, et ce que je pense à écrire.</p>
<h2 id="mon-expérience"><a class="header" href="#mon-expérience">Mon expérience</a></h2>
<p>Même si j'ai connu <code>MS-DOS</code>, <code>Windows 3.1</code>, <code>Windows 95</code>,
ce n'est qu'à la découverte de <code>GNU/Linux</code> que mon aventure
informatique démarre rééllement.</p>
<p>Et même si j'ai testé beaucoup de distros, il est possible
de ce contenter de cette timeline grossière:</p>
<div class="table-wrapper"><table><thead><tr><th>Année</th><th>Distro/OS</th></tr></thead><tbody>
<tr><td>1997</td><td>Linux Slackware</td></tr>
<tr><td>1998</td><td>Redhat</td></tr>
<tr><td>2000</td><td>Debian</td></tr>
<tr><td>2005</td><td>Gentoo</td></tr>
<tr><td>2008</td><td>Archlinux</td></tr>
<tr><td>2024</td><td>NixOS</td></tr>
</tbody></table>
</div>
<h2 id="solutions-à-des-problèmes"><a class="header" href="#solutions-à-des-problèmes">Solutions à des problèmes</a></h2>
<h3 id="hardening"><a class="header" href="#hardening">Hardening</a></h3>
<h4 id="filesystem"><a class="header" href="#filesystem">Filesystem</a></h4>
<p>Empêcher une application de saturer le disque système,
par exemple via l'écriture de logs.</p>
<ul>
<li><a href="./zfs/datasets.html#configurer-un-quota">ZFS - Datasets - Quotas</a></li>
</ul>
<h4 id="services"><a class="header" href="#services">Services</a></h4>
<p>Restreindre les droits d'un service</p>
<ul>
<li><a href="systemd/portables.services.html#isolation">Systemd - portable services</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="zfs"><a class="header" href="#zfs">ZFS</a></h1>
<p><code>ZFS</code> est un système de fichier incroyable, qui résoud un ensemble de
problèmes "du quotidien" de manière élégante et fiable.</p>
<p>Ce système de fichier a tellement bousculé l'univers des systèmes de fichiers
qu'il a créé une concurrence, qui du coté du monde linux s'appelle
<a href="https://fr.wikipedia.org/wiki/Btrfs">Btrfs</a> (mais qui n'est pas au niveau).</p>
<p>Ces dernières années, j'ai eu de nombreuses occasions de sortir ce
fabuleux <code>gif</code>, suite à des incidents chronophages qui n'auraient pas
existés, ou bien auraient étés résolus bien plus rapidement, si nous avions
utilisé <code>ZFS</code>:</p>
<p><img src="zfs/merde.cest.con.ca.gif" alt="On a pas utilisé ZFS" /></p>
<p>En effet, lorsque les bras vous en tombent, d'avoir à résoudre manuellement
des problèmes basiques, parce que nous n'avons pas pus étudier la mise
en place d'autres solutions, il ne vous reste que la création de <code>gifs</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire"><a class="header" href="#histoire">Histoire</a></h1>
<p><code>ZFS</code> est un système de fichiers initialement développé par
<a href="https://fr.wikipedia.org/wiki/Sun_Microsystems">Sun Microsystems</a>
en 2005.</p>
<p>Il se distingue à l'époque sur plusieurs aspects clairement novateurs:</p>
<ol>
<li>Résilient aux pannes, nous avons à l'époque des conférences des
ingénieurs <code>Sun</code> qui nous montrent qu'ils peuvent percer les disques
d'un raid <code>ZFS</code> actuellement en cours d'utilisation, sans impact sur
la disponibilité du raid.</li>
<li>Prévu pour le futur avec des limites sur le nombre de fichiers, leur
taille maximale, la taille maximale du <code>zpool</code>...</li>
<li>La possibilité de créér des datasets (re)configurables contrairement
aux classiques <code>partitions</code>.</li>
<li>La possibilité de créér des snapshots sans coût, instantannés, et une
gestion très fine des données entre les snapshots.</li>
</ol>
<h2 id="mon-expérience-1"><a class="header" href="#mon-expérience-1">Mon expérience</a></h2>
<p>J'ai utilisé <code>ZFS</code> sur du perso dès 2009.<br />
Je l'ai utilisé sur de la prod dès 2012.</p>
<p>J'ai géré jusqu'à ~400 serveurs de prod avec du <code>ZFS on root</code>,
ce qui me permet d'être solide sur mon expérience avec ce système
de fichier, et donc, de <strong>savoir</strong> les gains qu'il apporte, les problèmes
qu'il permet d'<strong>éviter</strong>.</p>
<p>À ce jour (2025), mon PC perso est toujours sur <code>ZFS</code> → <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food">Eat your own dog food</a>.</p>
<h2 id="sources"><a class="header" href="#sources">Sources</a></h2>
<ol>
<li><a href="https://fr.wikipedia.org/wiki/ZFS">ZFS - Wikipédia</a>.</li>
<li><a href="https://connect.ed-diamond.com/GNU-Linux-Magazine/glmf-114/zfs-sous-gnu-linux">GNU/Linux Magazine</a> - article de 2009, qui m'a lancé dans l'aventure <code>ZFS</code>.</li>
<li><a href="https://ikrima.dev/dev-notes/homelab/zfs-for-dummies/">ZFS for Dummies</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="les-cas-pratiques"><a class="header" href="#les-cas-pratiques">Les cas pratiques</a></h1>
<ul>
<li><a href="zfs/./datasets.html">Datasets</a></li>
<li><a href="zfs/./snapshots.html">Snapshots</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="datasets"><a class="header" href="#datasets">Datasets</a></h1>
<p>Les <code>datasets</code> sur <code>ZFS</code> sont des volumes qui sont créés sur un <code>zpool</code>
existant, et qui vont porter un ensemble de propriétées qui leur seront
propres ou héritées.</p>
<p>Chaque <code>dataset</code> est le fils d'un <code>dataset</code> ou directement du <code>zpool</code>.</p>
<p>Ce <code>dataset</code> sera mount comme un volume classique (par <code>ZFS</code>).</p>
<p>Les <code>datasets</code> peuvent être créés et détruits à tous moments.
Il est donc possible, en cas de nouveau besoin, d'adapter le système
de fichiers à celui-ci (par exemple un <code>dataset</code> par stack applicative
ou par utilisateur).</p>
<h2 id="pourquoi-cest-pratique"><a class="header" href="#pourquoi-cest-pratique">Pourquoi c'est pratique</a></h2>
<h3 id="réservation-disque"><a class="header" href="#réservation-disque">Réservation disque</a></h3>
<p>En configurant une réservation disque à l'avance, vous
pourrez vous assurer que cet espace lui soit dès le début
attribué, même s'il n'en fait pas l'usage immédiat.</p>
<p>C'est pour simplifier de la planification.</p>
<p>Exemple:</p>
<pre><code># zfs set reservation=5G zroot/root/home/web-user
</code></pre>
<pre><code># zfs list
NAME                        USED  AVAIL  REFER  MOUNTPOINT
zroot/root/home             5.00G  33.5G  8.50K  /home
zroot/root/home/web-user    15.0K  33.5G  8.50K  /home/web-user
</code></pre>
<p>L'espace est donc directement consommé sur <code>zroot/root/home</code> (qui est lui
aussi un <code>dataset</code>), même si <code>zroot/root/home/web-user</code> ne contient encore
aucunes données.</p>
<p>Sources:</p>
<ul>
<li><a href="https://docs.oracle.com/cd/E19253-01/819-5461/gbdbb/index.html">Setting Reservations on ZFS File Systems</a></li>
</ul>
<h3 id="configurer-un-quota"><a class="header" href="#configurer-un-quota">Configurer un quota</a></h3>
<p>Il est possible de définir un usage disque max sur un dataset.<br />
Sela permet d'empêcher une application, un utilisateur, ou un élément système
de consommer l'intégralité de l'espace du <code>zpool</code> en cas de défaut.</p>
<p>Le cas le plus classique étant la création de logs qui viennent saturer
le système.</p>
<p>Même si <code>journalctl</code> est configurable pour disposer d'une taille max des
logs, les applications n'utilisent pas toutes <code>journalctl</code>.</p>
<p>Exemple:</p>
<pre><code># zfs set quota=10G zroot/root/var/log
# zfs get quota zroot/root/var/log
NAME                PROPERTY  VALUE  SOURCE
zroot/root/var/log  quota     10G    local
</code></pre>
<p>Sources:</p>
<ul>
<li><a href="https://docs.oracle.com/cd/E23823_01/html/819-5461/gazvb.html">Setting ZFS Quotas and Reservations</a></li>
</ul>
<h3 id="compresser-les-données"><a class="header" href="#compresser-les-données">Compresser les données</a></h3>
<p>Si vous crééz un dataset dont vous savez à l'avance que les données
se compressent bien, alors vous pouvez activer.</p>
<p>Il est possible de choisir l'algorithme de compression, ainsi
qu'obtenir des stats sur son efficacité.</p>
<p>Il est évident que cela va surtout très bien s'appliquer pour
un <code>dataset</code> qui va contenir des logs.</p>
<p>Exemple:</p>
<pre><code># zfs set compression=on zroot/root/var/log
# zfs get compression zroot/root/var/log
NAME               PROPERTY     VALUE      SOURCE
zroot/root/var/log compression  on         local
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="snapshots"><a class="header" href="#snapshots">Snapshots</a></h1>
<p>Supposons un site web <code>PHP</code> classique avec une db <code>MariaDB</code> sous forme
de stack <code>docker compose</code>.<br />
Cette stack serait déclarée dans un dossier <code>/srv/docker/victim.org</code>.<br />
Le nom du dataset sera <code>zroot/srv/docker/victim.org</code>.</p>
<h2 id="création-dun-snapshot"><a class="header" href="#création-dun-snapshot">Création d'un snapshot</a></h2>
<pre><code class="language-bash">zfs snap zroot/srv/docker/victim.org@$(date +%Y-%m-%d-%H-%M-%S)
</code></pre>
<h2 id="liste-des-derniers-snapshots"><a class="header" href="#liste-des-derniers-snapshots">Liste des derniers snapshots</a></h2>
<pre><code>$  /s/d/victim.org  zfs list -H -rt snapshot -o name zroot/srv/docker/victim.org | tail -n5                                                                                                                                                                                                                                    4359ms  mar. 08 août 2023 16:14:41
zroot/srv/docker/victim.org@2023-08-04-00-00-08
zroot/srv/docker/victim.org@2023-08-05-00-00-13
zroot/srv/docker/victim.org@2023-08-06-00-00-04
zroot/srv/docker/victim.org@2023-08-07-00-00-04
zroot/srv/docker/victim.org@2023-08-08-00-00-06
</code></pre>
<h2 id="fichiers-modifiés-depuis-le-dernier-snapshot"><a class="header" href="#fichiers-modifiés-depuis-le-dernier-snapshot">Fichiers modifiés depuis le dernier snapshot</a></h2>
<pre><code>$  /s/d/victim.org  just diff                                                                                                                                                                                                                                                         mar. 08 août 2023 16:13:49
zfs diff $(zfs list -H -rt snapshot -o name zroot/srv/docker/victim.org | tail -n1)
M   /srv/docker/victim.org/db/ibdata1
M   /srv/docker/victim.org/db/ib_logfile0
M   /srv/docker/victim.org/db/ib_logfile1
M   /srv/docker/victim.org/db/victim/wp_options.ibd
M   /srv/docker/victim.org/code/wp-content
M   /srv/docker/victim.org/db/ibtmp1
+   /srv/docker/victim.org/backup/1691460000_2023-08-08_victim.sql
M   /srv/docker/victim.org/backup
</code></pre>
<h2 id="naviguer-dans-un-mount-du-snapshot"><a class="header" href="#naviguer-dans-un-mount-du-snapshot">Naviguer dans un mount du snapshot</a></h2>
<p>Pour voir le contenu du snapshot <code>2023-08-08-00-00-06</code> de notre stack,
nous pouvons aller dedans (<code>read-only</code>):</p>
<pre><code>cd /srv/docker/victim.org/.zfs/snapshots/2023-08-08-00-00-06
</code></pre>
<h2 id="rollback-la-stack-à-un-snapshot"><a class="header" href="#rollback-la-stack-à-un-snapshot">Rollback la stack à un snapshot</a></h2>
<pre><code>zfs rollback -r zroot/srv/docker/victim.org@2023-08-08-00-00-06
</code></pre>
<h2 id="exporter-la-stack"><a class="header" href="#exporter-la-stack">Exporter la stack</a></h2>
<p>Grâce à <code>zfs send</code>, il est possible d'exporter un <code>snapshot</code> comme bon
nous semble.</p>
<p>Si notre stack <code>docker compose</code> ne déclare que des volumes de type
<code>bind mount</code>, situés dans le même dossier, alors déplacer toute la stack
devient trivial!</p>
<p><code>zfs send</code> pourra être invoqué ainsi:</p>
<pre><code>zfs send zroot/srv/docker/victim.org@2023-08-08-00-00-06
</code></pre>
<p>Exporter en tant que fichier:</p>
<pre><code>zfs send zroot/srv/docker/victim.org@2023-08-08-00-00-06 &gt;/root/backup.victim.org.raw
</code></pre>
<p>Exporter via <code>SSH</code>:</p>
<pre><code>zfs send zroot/srv/docker/victim.org@2023-08-08-00-00-06 | ssh $host "zfs recv zroot/srv/docker/victim.org"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="outils"><a class="header" href="#outils">Outils</a></h1>
<h2 id="zfs-prune-snapshots"><a class="header" href="#zfs-prune-snapshots">zfs-prune-snapshots</a></h2>
<p><a href="https://github.com/bahamas10/zfs-prune-snapshots">bahamas10/zfs-prune-snapshots</a>
permet de gérer le nombre de snapshots à conserver.</p>
<h2 id="zrepl"><a class="header" href="#zrepl">zrepl</a></h2>
<p><a href="https://github.com/zrepl/zrepl">zrepl</a> permet de répliquer des datasets
entre plusieurs serveurs, que ce soit en mode <code>push</code> ou <code>pull</code>.</p>
<p>Même s'il peut être difficile de démarrer avec <code>zrepl</code> (j'ai trouvé
la documentation peu claire), le résultat est vraiment convaincant.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix"><a class="header" href="#nix">Nix</a></h1>
<h2 id="nix-1"><a class="header" href="#nix-1">Nix</a></h2>
<p><a href="https://nixos.org/">Nix</a> c'est:</p>
<ol>
<li>Un langage de programmation.</li>
<li>Un gestionnaire de packages.</li>
<li>Un système de build.</li>
</ol>
<p>Pour cela, il mobilise plusieurs concepts:</p>
<ol>
<li>C'est un langage de <a href="https://fr.wikipedia.org/wiki/Programmation_purement_fonctionnelle">programmation purement</a> fonctionnel.</li>
<li>Il est <a href="https://fr.wikipedia.org/wiki/Programmation_d%C3%A9clarative">déclaratif</a>.</li>
<li>Il est <a href="https://fr.wikipedia.org/wiki/%C3%89valuation_paresseuse">paresseux</a></li>
<li>Le résultat de son travail est <a href="https://en.wikipedia.org/wiki/Reproducible_builds">reproductible</a></li>
<li>Le résultat de son travail est <a href="https://fr.wikipedia.org/wiki/Portabilit%C3%A9_(informatique)">portable</a></li>
</ol>
<h2 id="nixos"><a class="header" href="#nixos">NixOS</a></h2>
<p><a href="https://nixos.org/">NixOS</a> c'est:</p>
<ol>
<li>Une distribution GNU/Linux initiée en 2006.</li>
<li>Une première version stable en 2013.</li>
<li>Une OS entièrement créé de manière <strong>déclarative</strong>, et <strong>reproductible</strong></li>
</ol>
<p><code>NixOS</code> est clairement un OVNI dans le monde <code>GNU/Linux</code> tant
il se distingue.</p>
<p>Son seul concurrent dans son domaine est <a href="https://fr.wikipedia.org/wiki/GNU_Guix">GNU/Guix</a>.</p>
<h2 id="sources-1"><a class="header" href="#sources-1">Sources</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/NixOS">NixOS - Wikipedia</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/Nix_(package_manager)">Nix - Wikipedia</a>.</li>
<li><a href="https://blog.stephane-robert.info/docs/securiser/os-immuable/nixos/">NixOS : immuable et reproductible</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire-1"><a class="header" href="#histoire-1">Histoire</a></h1>
<p><code>Nix</code> est un projet démarré en 2003 par <code>Eelco Dolstra</code>,
qui prendra du temps à se mettre en place, car il bouscule tout l'existant.</p>
<ul>
<li><a href="https://edolstra.github.io/pubs/iscsd-scm11-final.pdf">Integrating Software Construction and Software Deployment</a> - 2003</li>
<li><a href="https://edolstra.github.io/pubs/nspfssd-lisa2004-final.pdf">Nix: A Safe and Policy-Free System for Software Deployment</a> - 2004</li>
<li><a href="https://edolstra.github.io/pubs/phd-thesis.pdf">The Purely Functional Software Deployment Model</a> - 2006</li>
</ul>
<h2 id="mon-expérience-2"><a class="header" href="#mon-expérience-2">Mon expérience</a></h2>
<p>Bien que j'ai pris connaissance de <code>NixOS</code> en 2017 via une
brève sur <a href="https://linuxfr.org/news/l-heure-du-test-episode-1-nixos">LinuxFR.org</a>,
mon intérêt était focalisé sur d'autres projets, et j'étais encore
bien trop lié à <a href="https://archlinux.fr/">Archlinux</a> (depuis 2008).</p>
<p>J'ai commencé <code>Nix</code> en 2023 via <a href="nix/devbox.html">Devbox</a>, qui a été convaincant,
m'a poussé a essayer <a href="nix/home-manager.html">home-manager</a>.</p>
<p>1 an plus tard, je passai mon PC perso sous <code>NixOS</code> et commençait à écrire
des <a href="nix/flakes.html">flakes</a>.</p>
<p>Il me semble, à ce jour, que c'est un excellent moyen de s'embarquer dans
l'aventure <code>Nix</code>, par étapes.</p>
<h2 id="sources-2"><a class="header" href="#sources-2">Sources</a></h2>
<ul>
<li><a href="https://linuxfr.org/news/l-heure-du-test-episode-1-nixos">L'heure du test - épisode 1 - NixOS</a>.</li>
<li><a href="https://linuxfr.org/users/killruana/journaux/nixos-ou-comment-j-ai-rendu-mes-machines-interchangeables-et-ennuyeuses">Journal NixOS ou comment j'ai rendu mes machines interchangeables et ennuyeuses</a>.</li>
<li><a href="https://linuxfr.org/news/donnez-moi-un-nixos-a-ronger">Donnez moi un NixOS à ronger</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="devbox"><a class="header" href="#devbox">Devbox</a></h1>
<p><a href="https://www.jetify.com/devbox">Devbox</a> permet de créér des environnements
reproductibles entre différentes machines.</p>
<p>Ce projet se distingue des autres par son extrême simplicité:<br />
<strong>vous n'avez pas besoin de savoir utiliser <code>nix</code> pour utiliser <code>devbox</code></strong>.</p>
<p>Il s'agit d'une surcouche à <code>nix</code> et aux <code>flakes</code>, afin de rendre le tout
immédiatement utilisable pour créér des environnements de travail sur des
projets!</p>
<h2 id="exemple-ansible"><a class="header" href="#exemple-ansible">Exemple Ansible</a></h2>
<h3 id="en-local-sous-archlinux"><a class="header" href="#en-local-sous-archlinux">En local sous archlinux</a></h3>
<p>Depuis un PC sous <a href="https://archlinux.fr/">Archlinux</a> avec <code>nix</code> + <a href="https://www.jetify.com/devbox">Devbox</a>,
j'ai <code>ansible</code> qui a été installé depuis les packages <code>archlinux</code>:</p>
<pre><code class="language-bash"> kuri@Nomad  ansible  16:33  which ansible
/usr/sbin/ansible
 kuri@Nomad  ansible  16:33  ansible --version
ansible [core 2.20.0]
  config file = None
  configured module search path = ['/home/kuri/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.13/site-packages/ansible
  ansible collection location = /home/kuri/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/sbin/ansible
  python version = 3.13.11 (main, Dec  7 2025, 13:01:45) [GCC 15.2.1 20251112] (/usr/bin/python)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
</code></pre>
<p>Nous avons <code>ansible</code> + <code>jinja</code> + <code>python</code> ainsi que diverses librairies
<code>python</code> afin que notre installation d'<code>ansible</code> soit fonctionnelle.</p>
<p>Pour cela, sous archlinux, j'ai fait <code>pacman -S ansible</code>.</p>
<h3 id="le-problème-cest-les-autres"><a class="header" href="#le-problème-cest-les-autres">Le problème c'est les autres</a></h3>
<p>Si j'ai 3 collègues, sous les OS suivants:</p>
<ol>
<li>Windows (WSL)</li>
<li>macOS</li>
<li>Ubuntu</li>
</ol>
<p>Je vais devoir leur dire de se débrouiller, pour voir comment installer
<code>ansible</code> sur leurs machines.</p>
<h3 id="la-solution-cest-devbox"><a class="header" href="#la-solution-cest-devbox">La solution c'est devbox</a></h3>
<p>Ou alors, je passe à la méthode <a href="https://www.jetify.com/devbox">Devbox</a>:</p>
<pre><code class="language-bash"> kuri@Nomad  ansible  16:35  devbox init
 kuri@Nomad  ansible  16:39  devbox add ansible
Info: Adding package "ansible@latest" to devbox.json
 kuri@Nomad  ansible  16:39  devbox shell
Info: Ensuring packages are installed.
✓ Computed the Devbox environment.
Starting a devbox shell...
Linux Nomad 6.17.9-arch1-1 x86_64
 16:40:06  up   8:34,  1 user,  load average: 0,38, 0,24, 0,28
(devbox)  kuri@Nomad  ansible  16:40  ansible --version
ansible [core 2.20.0]
  config file = None
  configured module search path = ['/home/kuri/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /nix/store/06p0i8w8zqrinjwldnypkva8s6ivz0r0-python3.13-ansible-core-2.20.0/lib/python3.13/site-packages/ansible
  ansible collection location = /home/kuri/.ansible/collections:/usr/share/ansible/collections
  executable location = /nix/store/06p0i8w8zqrinjwldnypkva8s6ivz0r0-python3.13-ansible-core-2.20.0/bin/ansible
  python version = 3.13.9 (main, Oct 14 2025, 13:52:31) [GCC 14.3.0] (/nix/store/3lll9y925zz9393sa59h653xik66srjb-python3-3.13.9/bin/python3.13)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
</code></pre>
<p>Si ce dossier se trouve être un dépôt <code>git</code>, dans lequel je commit les fichiers
<code>devbox.{json,lock}</code>, tout personne qui le clone va travailler avec les mêmes
versions de packages que ceux définis dans <code>devbox.lock</code>.<br />
Et donc, à moins d'un bug spécifique à l'OS, tout le reste fonctionnera
à l'identique (y compris sous <code>ARM</code>).</p>
<h3 id="installer-ansible-core-216"><a class="header" href="#installer-ansible-core-216">Installer ansible-core 2.16</a></h3>
<p>Que ce soit via <code>devbox search ansible</code> ou <a href="https://www.nixhub.io/packages/ansible">Nixhub</a>,
je peux lister d'autres versions d'ansible disponibles.</p>
<p>Dans le cas de gestion de serveurs d'une autre époque (article écrit en décembre 2025), par exemple:</p>
<ol>
<li>CentOS 7</li>
<li>Amazon Linux 2</li>
<li>Debian 10</li>
</ol>
<p>La version <code>2.17</code> casse le support de ces versions, et nous devons donc utiliser la version
<code>2.16</code>, qui n'est globalement plus packagée.</p>
<p>Dans un monde ancien, nous aurions sous le coude une VM sous une version périmée
de <code>Debian</code> (genre la <code>10</code>), qui pointe sur le dépôt des archives, et qui aurait
<code>ansible 2.16</code> + toutes les deps à la bonne version, et on bichonnerait cette VM
comme le saint graal.</p>
<p>Ou, encore pire, on considère que des outils de gestion de config/conformité, c'est mal,
car les dernières versions ne supportent plus les dinos (le vrai problème
étant qu'on ne sait pas MAJ les serveurs).</p>
<p>Maintenant, réglons ce problème à la manière de <a href="https://www.jetify.com/devbox">Devbox</a>:</p>
<pre><code class="language-bash"> kuri@Nomad  ansible  17:22  devbox rm ansible
 kuri@Nomad  ansible  17:22  devbox add ansible@2.16.5
Info: Adding package "ansible@2.16.5" to devbox.json
Info: Installing the following packages to the nix store: ansible@2.16.5
 kuri@Nomad  ansible  17:23  devbox shell
Info: Ensuring packages are installed.
✓ Computed the Devbox environment.
Starting a devbox shell...
Linux Nomad 6.17.9-arch1-1 x86_64
 17:23:16  up   9:18,  1 user,  load average: 0,95, 0,50, 0,65
(devbox)  kuri@Nomad  ansible  17:23  ansible --version
ansible [core 2.16.5]
  config file = None
  configured module search path = ['/home/kuri/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /nix/store/a5k2lpbxj419kzn2pyz55gql35pbg8xx-python3.12-ansible-core-2.16.5/lib/python3.12/site-packages/ansible
  ansible collection location = /home/kuri/.ansible/collections:/usr/share/ansible/collections
  executable location = /nix/store/a5k2lpbxj419kzn2pyz55gql35pbg8xx-python3.12-ansible-core-2.16.5/bin/ansible
  python version = 3.12.4 (main, Jun  6 2024, 18:26:44) [GCC 13.3.0] (/nix/store/04gg5w1s662l329a8kh9xcwyp0k64v5a-python3-3.12.4/bin/python3.12)
  jinja version = 3.1.4
  libyaml = True
</code></pre>
<p>Que je sois sous <code>Archlinux</code>, <code>NixOS</code>, <code>Ubuntu</code>, <code>macOS</code>, <code>Windows</code>,
et peu importe les versions, tant que j'ai <code>devbox</code> (et donc <code>nix</code>),
j'ai cette reproductibilité sur des milliers de packages, ainsi que
les anciennes versions de ces packages, dans des envs isolé et
reproductibles!</p>
<h2 id="sources-3"><a class="header" href="#sources-3">Sources</a></h2>
<ul>
<li><a href="https://www.jetify.com/docs/devbox">What is Devbox?</a></li>
<li><a href="https://medium.com/vafion/devbox-a-user-friendly-approach-to-reproducible-development-environments-with-nix-83dbcd0ab8d8">Devbox: A User-Friendly Approach to Reproducible Development Environments with Nix</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="flakes"><a class="header" href="#flakes">flakes</a></h1>
<p>les <code>nix flakes</code> sont un moyen d'écrire des expressions <code>nix</code> dans
le but de:</p>
<ul>
<li>Packager un outil.</li>
<li>Créér une VM.</li>
<li>Installer/Configurer son système.</li>
<li>Installer/Configurer un système distant.</li>
<li>Créér un environnement de développement.</li>
</ul>
<p>Bien qu'extrêmement puissant, il s'agit d'un outil fort compliqué
à utiliser, car il requiert de savoir écrire dans le langage <code>nix</code>.</p>
<p>C'est pourquoi je ne recommande pas de se lancer dans l'aventure
<code>nix</code> en partant directement sur <code>nixos</code> + des <code>flakes</code> pour décrire
intégralement son OS et ses environnements de travail.</p>
<p>Il faut savoir s'approprier les outils par étapes, pour ne pas s'en
dégouter ou se dévaloriser suite à un effort trop complexe pour
être fait en une seule fois.</p>
<p><a href="nix/devbox.html">Devbox</a> est un moyen beaucoup plus rapide pour commencer
à créér des environnements de travail, tout en effectuant un premier
pas vers <code>nix</code>!</p>
<h2 id="modules"><a class="header" href="#modules">Modules</a></h2>
<p>Il est possible d'écrire des <code>flakes</code> sous forme de modules,
qui pourront être utilisés par d'autres <code>flakes</code>, afin de ne pas
toujours ré-inventer la roue.</p>
<h2 id="sources-4"><a class="header" href="#sources-4">Sources</a></h2>
<ul>
<li><a href="https://wiki.nixos.org/wiki/Flakes">Flakes - Official NixOS Wiki</a></li>
<li><a href="https://xeiaso.net/blog/paranoid-nixos-2021-07-18/">Paranoid NixOS Setup</a></li>
<li><a href="https://github.com/nix-community/impermanence">Nix Impermanence</a></li>
<li><a href="https://github.com/oddlama/nix-config/tree/main">oddlama/nix-config</a> - Exemple de
<code>flakes</code> pour gérer plusieurs hôtes sous <code>NixOS</code>.</li>
<li><a href="https://oblivion.keyruu.de/Homelab/NixOS-for-Servers">Is NixOS the best OS for servers?</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="direnv"><a class="header" href="#direnv">direnv</a></h1>
<p><a href="https://github.com/direnv/direnv">direnv</a> est un outil qui se greffe sur
votre shell afin de pouvoir automatiquement installer/charger des outils,
et executer des commandes, lorsque vous entrez dans un répertoire (<code>cd</code>).</p>
<p>Se reposant sur les gains que permet <code>nix</code> (et surtout les <a href="nix/flakes.html">flakes</a>), il permettra de configurer
automatiquement des envs de travail, en faisant au maximum abstraction
de l'OS que l'on utilise.</p>
<p>Sans avoir à connaitre par avance les spécificitées d'un projet
(ses dépendances), il sera possible de commencer à travailler dessus.</p>
<p>Exemples d'usages:</p>
<ul>
<li>Installer les outils <code>rust</code>+<code>cargo</code>+<code>cc</code> pour compiler un projet <code>rust</code>.</li>
<li>Installer <code>mdBooks</code> ou <code>mkdocs</code> pour build/visualiser de la documentation.</li>
<li>Installer les bonnes versions d'<code>ansible</code> ou <code>terraform</code> pour être
compatible avec les contraintes d'une infra.</li>
</ul>
<h2 id="sources-5"><a class="header" href="#sources-5">Sources</a></h2>
<ul>
<li><a href="https://direnv.net/">direnv.net</a>.</li>
<li><a href="https://determinate.systems/blog/nix-direnv/">Effortless dev environments with Nix and direnv</a>.</li>
<li><a href="https://nix.dev/guides/recipes/direnv.html">Automatic environment activation with direnv</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="home-manager"><a class="header" href="#home-manager">home-manager</a></h1>
<p><a href="https://github.com/nix-community/home-manager">home-manager</a>
est du code <code>nix</code> sous forme de <a href="nix/flakes.html">flakes</a> qui vont vous permettre
de gérer des environnements utilisateurs.</p>
<p>Classiquement, sous <code>GNU/Linux</code>, vous installez des outils au niveau
<code>système</code>, et tous ces outils sont disponibles à tous les utilisateurs.</p>
<p>Avec <code>home-manager</code>, vous allez pouvoir séparer les outils, c'est à dire
que vous continuerez d'avoir des outils disponibles au niveau <code>système</code>,
<strong>mais</strong> vous pourrez enrichir les environnements de certains utilisateurs.</p>
<p>l'idée est donc de garder la partie <code>système</code> la plus <strong>light possible</strong>,
et de seulement charger les utilisateurs qui ont besoins d'outils.</p>
<p>Il va aussi permettre de gérer les <a href="https://wiki.archlinux.org/title/Dotfiles">dotfiles</a>,
mais à un niveau inégalé par les différents outils de gestion de <a href="https://wiki.archlinux.org/title/Dotfiles">dotfiles</a>
existants.</p>
<p>Utilisateur <code>GNU/Linux</code> depuis 1997, le sujet des <a href="https://wiki.archlinux.org/title/Dotfiles">dotfiles</a>
d'une machine à l'autre, ou à force de réinstalls, je l'ai clairement poncé.</p>
<p>Absolument rien n'a été plus pratique que <a href="https://github.com/nix-community/home-manager">home-manager</a>
qui hérite des gains de <code>nix</code>, des <a href="nix/flakes.html">flakes</a>, et donc va non
seulement permettre d'installer des packages en espace utilisateur, mais
va créér des <strong>services systemd en espace utilisateur</strong>, et permettre de
<strong>générer les dotfiles</strong> de façon <strong>reproductible</strong> grâce à <code>nix</code>!</p>
<p><code>home-manager</code> est <code>Multi-OS</code>, je m'en suis d'abord servit sous <a href="https://archlinux.fr/">Archlinux</a>,
vous pouvez vous en servir sous <code>macOS</code>... Il n'est pas necessaire d'être sous <a href="https://nixos.org/">NixOS</a>.</p>
<h2 id="sources-6"><a class="header" href="#sources-6">Sources</a></h2>
<ul>
<li><a href="https://nix-community.github.io/home-manager/">Home Manager Manual</a>.</li>
<li><a href="https://ghedam.at/24353/tutorial-getting-started-with-home-manager-for-nix">Tutorial: Getting started with Home Manager for Nix</a>.</li>
<li><a href="https://github.com/Evertras/simple-homemanager">Evertras/simple-homemanager</a> A practical guide to getting
started with home manager with flakes and all that 2024 goodness.</li>
<li><a href="https://home-manager-options.extranix.com/">Home Manager - Option Search</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemd"><a class="header" href="#systemd">Systemd</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemctl"><a class="header" href="#systemctl">systemctl</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="portable-services"><a class="header" href="#portable-services">portable services</a></h1>
<p>Depuis la <code>v239</code> (2018) de <a href="https://systemd.io/">Systemd</a>, est introduit la
notion de <a href="https://systemd.io/PORTABLE_SERVICES/">Portable Services</a>.</p>
<h2 id="en-quoi-cela-va-nous-interesser"><a class="header" href="#en-quoi-cela-va-nous-interesser">En quoi cela va nous interesser?</a></h2>
<h3 id="isolation"><a class="header" href="#isolation">Isolation</a></h3>
<ul>
<li>Il est possible de donner accès à une partie du système de fichiers
du host via <code>BindPaths=</code> et <code>BindReadOnlyPaths=</code>, pour y stocker
des datas dites "dynamiques", ressemblant aux volumes sur <code>Docker</code>.<br />
Pour le reste, le service est <code>chroot</code>.</li>
<li>Si le service est compromis, les accès au système sont restreints.</li>
<li>Pour les mises à jour, on <code>detach</code> l'image <code>.raw</code> de la version précédente
du service, et on <code>attach</code> la nouvelle version!<br />
C'est tout!<br />
Pas besoin de MAJ le système, votre démon est <strong>indépendant du
système sur lequel il s'execute!</strong>.
Vous pouvez MAJ le système sans impact sur le service, et inversement!</li>
</ul>
<p>Il va donc être possible d'avoir par exemple un dossier <code>/srv/startpage/</code>
contenant:</p>
<pre><code>.r--r--r-- root root 5.7 MB Thu Jan  1 01:00:01 1970  startpage_1.1.0.raw
.r--r--r-- root root 5.7 MB Thu Jan  1 01:00:01 1970  startpage_1.2.0.raw
.r--r--r-- root root 5.7 MB Thu Jan  1 01:00:01 1970  startpage_1.3.0.raw
</code></pre>
<p>et pouvoir upgrade le service dans le temps, et rollback sur l'image d'avant
en cas de problème.</p>
<h3 id="reproductibilité"><a class="header" href="#reproductibilité">Reproductibilité</a></h3>
<ul>
<li>On package notre démon dans une image <code>.raw</code>.
Cette image embarque le service et toutes ses dépendances.
Peu importe la distribution, il se comportera de la même manière.</li>
<li><a href="systemd/nix/index.html">Nix</a> sait construire des images <a href="https://systemd.io/PORTABLE_SERVICES/">Portable Services</a>
via <a href="https://ryantm.github.io/nixpkgs/builders/images/portableservice/#sec-pkgs-portableService">pkgs.portableService</a>.</li>
</ul>
<h3 id="léger"><a class="header" href="#léger">Léger</a></h3>
<ul>
<li>C'est plus léger que <code>docker</code> (pas de surcouche / isolation réseau).</li>
</ul>
<h2 id="pour-quelles-limites"><a class="header" href="#pour-quelles-limites">Pour quelles limites?</a></h2>
<p>Lorsque l'on commence à vouloir faire discuter plusieurs services,
<code>docker compose</code> (ou similaire) va s'imposer naturellement pour continuer
de bosser en <code>isolation</code>, avec <code>reproductibilité</code>.</p>
<h2 id="sources-7"><a class="header" href="#sources-7">Sources</a></h2>
<ul>
<li><a href="https://systemd.io/PORTABLE_SERVICES/">Systemd - Portable services</a></li>
<li><a href="https://0pointer.net/blog/walkthrough-for-portable-services.html">Walkthrough for Portable Services</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker"><a class="header" href="#docker">Docker</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire-2"><a class="header" href="#histoire-2">Histoire</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="traefik"><a class="header" href="#traefik">traefik</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="watchtower"><a class="header" href="#watchtower">watchtower</a></h1>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
