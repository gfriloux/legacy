<!DOCTYPE HTML>
<html lang="fr" class="latte sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>My legacy</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="theme/catppuccin.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "latte";
            const default_dark_theme = "mocha";
            window.path_to_searchindex_js = "searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('latte')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">My legacy</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="mon-héritage"><a class="header" href="#mon-héritage">Mon héritage</a></h1>
<p>Ce livre est l'héritage de mes connaissances, en fonction du temps que
j'ai pour l'écrire, et ce que je pense à écrire.</p>
<h2 id="mon-expérience"><a class="header" href="#mon-expérience">Mon expérience</a></h2>
<p>Même si j'ai connu <code>MS-DOS</code>, <code>Windows 3.1</code>, <code>Windows 95</code>,
ce n'est qu'à la découverte de <code>GNU/Linux</code> que mon aventure
informatique démarre rééllement.</p>
<p>Et même si j'ai testé beaucoup de distros, il est possible
de se contenter de cette timeline grossière:</p>
<div class="table-wrapper"><table><thead><tr><th>Année</th><th>Distro/OS</th></tr></thead><tbody>
<tr><td>1997</td><td>Slackware</td></tr>
<tr><td>1998</td><td>Redhat</td></tr>
<tr><td>2000</td><td>Debian</td></tr>
<tr><td>2005</td><td>Gentoo</td></tr>
<tr><td>2008</td><td>Archlinux</td></tr>
<tr><td>2024</td><td>NixOS</td></tr>
</tbody></table>
</div>
<h2 id="solutions-à-des-problèmes"><a class="header" href="#solutions-à-des-problèmes">Solutions à des problèmes</a></h2>
<h3 id="hardening"><a class="header" href="#hardening">Hardening</a></h3>
<h4 id="docker"><a class="header" href="#docker">Docker</a></h4>
<ul>
<li><a href="docker/startpage.html#pourquoi-utiliser-nix">startpage - Pourquoi utiliser nix?</a></li>
</ul>
<h4 id="filesystem"><a class="header" href="#filesystem">Filesystem</a></h4>
<p>Empêcher une application de saturer le disque système,
par exemple via l'écriture de logs.</p>
<ul>
<li><a href="./zfs/datasets.html#configurer-un-quota">ZFS - Datasets - Quotas</a></li>
</ul>
<h4 id="services"><a class="header" href="#services">Services</a></h4>
<p>Restreindre les droits d'un service</p>
<ul>
<li><a href="systemd/portables.services.html#isolation">Systemd - portable services</a></li>
<li><a href="systemd/systemctl.html#hardening">Systemd - systemctl hardening</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="mon-environnement"><a class="header" href="#mon-environnement">Mon environnement</a></h1>
<p>En tant que dinosaure, je suis encore principalement avec des outils
qui s'executent dans un terminal.</p>
<p>Cela correspond à ma philosophie :</p>
<ul>
<li>Si c'est simple, et fait le boulot, ça suffit.</li>
<li>Les interfaces graphiques coopèrent mal ensemble.</li>
<li>C'est moins gourmand en ressources.</li>
<li>Je suis un gros nostalgique d'une époque maintenant phantasmée:
les années 80/90.</li>
</ul>
<h2 id="ma-stack"><a class="header" href="#ma-stack">Ma stack</a></h2>
<p>Globalement, mes outils necessaires sont dans mon dépôt
<a href="https://github.com/gfriloux/nix-cli/tree/main">gfriloux/nix-cli</a>.</p>
<p>Je vais lister ceux qui pour moi offrent une synergie interessante:</p>
<div class="table-wrapper"><table><thead><tr><th>Outil</th><th>Description</th></tr></thead><tbody>
<tr><td><a href="https://github.com/fish-shell/fish-shell">fish</a></td><td>Shell en <code>rust</code>, qui à l'usage m'est beaucoup plus utile que <code>bash</code>.</td></tr>
<tr><td><a href="https://github.com/atuinsh/atuin">atuin</a></td><td>Historique shell tellement plus moderne que <code>history</code>.</td></tr>
<tr><td><a href="https://github.com/sharkdp/bat">bat</a></td><td>Alternative à <code>cat</code>. J'ai un <code>alias</code> <code>bat</code> → <code>cat</code>.</td></tr>
<tr><td><a href="https://github.com/aristocratos/btop">btop</a></td><td>Alternative à <code>top</code>/<code>htop</code>.</td></tr>
<tr><td><a href="https://github.com/dandavison/delta">delta</a></td><td>Alternative à <code>diff</code>.</td></tr>
<tr><td><a href="https://github.com/junegunn/fzf">fzf</a></td><td>Fuzzy Finder dont les usages sont tellements nombreux...</td></tr>
<tr><td><a href="https://github.com/gfriloux/gitflow-toolkit">gitflow-toolkit</a></td><td>Outil d'aide au formattage des messages de commit.</td></tr>
<tr><td><a href="https://github.com/orf/git-workspace">git-workspace</a></td><td>Sync les dépôt <code>git</code> sur <code>gitlab</code>/<code>github</code>.</td></tr>
<tr><td><a href="https://github.com/charmbracelet/glow">glow</a></td><td>Lecteur <code>Markdown</code>.</td></tr>
<tr><td><a href="https://github.com/charmbracelet/gum">gum</a></td><td>Permet de créér des interfaces dans le terminal.</td></tr>
<tr><td><a href="https://github.com/casey/just">just</a></td><td>Alternative à <code>make</code>.</td></tr>
<tr><td><a href="https://github.com/lsd-rs/lsd">lsd</a></td><td>Alternative à <code>lsd</code>. J'ai un <code>alias</code> <code>lsd</code> → <code>ls</code>.</td></tr>
<tr><td><a href="https://github.com/zyedidia/micro">micro</a></td><td>Éditeur texte léger, en alternative à <code>nano</code>.</td></tr>
<tr><td><a href="https://github.com/rofl0r/ncdu">ncdu</a></td><td>Alternative à <code>du</code>.</td></tr>
<tr><td><a href="https://github.com/JanDeDobbeleer/oh-my-posh">oh-my-posh</a></td><td>Prompt customisable, avec différents thêmes disponibles sur le site.</td></tr>
<tr><td><a href="https://github.com/denilsonsa/prettyping">prettyping</a></td><td>Alternative à <code>prettyping</code>. J'ai un <code>alias</code> <code>prettyping</code> → <code>ping</code>.</td></tr>
<tr><td><a href="https://github.com/jbernard/pwgen">pwgen</a></td><td>Générateur de mots de passe.</td></tr>
<tr><td><a href="https://github.com/RsyncProject/rsync">rsync</a></td><td>Pour les transferts de fichiers.</td></tr>
<tr><td><a href="https://github.com/gfriloux/sshtui">sshtui</a></td><td>Interface pour les configs <code>ssh</code> en utilisant <a href="https://github.com/alexpasmantier/television">tv</a>.</td></tr>
<tr><td><a href="https://github.com/alexpasmantier/television">tv</a></td><td>Alternative à <code>fzf</code>.</td></tr>
<tr><td><a href="https://github.com/xcp-ng/xcp">xcp</a></td><td>Alternative à <code>cp</code>. J'ai un <code>alias</code> <code>xcp</code> → <code>cp</code>.</td></tr>
<tr><td><a href="https://github.com/zellij-org/zellij">zellij</a></td><td>Alternative à <code>screen</code>.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="zfs"><a class="header" href="#zfs">ZFS</a></h1>
<p><code>ZFS</code> est un système de fichier incroyable, qui résoud un ensemble de
problèmes "du quotidien" de manière élégante et fiable.</p>
<p>Ce système de fichier a tellement bousculé l'univers des systèmes de fichiers
qu'il a créé une concurrence, qui du coté du monde linux s'appelle
<a href="https://fr.wikipedia.org/wiki/Btrfs">Btrfs</a> (mais qui n'est pas au niveau).</p>
<p>Ces dernières années, j'ai eu de nombreuses occasions de sortir ce
fabuleux <code>gif</code>, suite à des incidents chronophages qui n'auraient pas
existés, ou bien auraient étés résolus bien plus rapidement, si nous avions
utilisé <code>ZFS</code>:</p>
<p><img src="zfs/merde.cest.con.ca.gif" alt="On a pas utilisé ZFS" /></p>
<p>En effet, lorsque les bras vous en tombent, d'avoir à résoudre manuellement
des problèmes basiques, parce que nous n'avons pas pus étudier la mise
en place d'autres solutions, il ne vous reste que la création de <code>gifs</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire"><a class="header" href="#histoire">Histoire</a></h1>
<p><code>ZFS</code> est un système de fichiers initialement développé par
<a href="https://fr.wikipedia.org/wiki/Sun_Microsystems">Sun Microsystems</a>
en 2005.</p>
<p>Il se distingue à l'époque sur plusieurs aspects clairement novateurs:</p>
<ol>
<li>Résilient aux pannes, nous avons à l'époque des conférences des
ingénieurs <code>Sun</code> qui nous montrent qu'ils peuvent percer les disques
d'un raid <code>ZFS</code> actuellement en cours d'utilisation, sans impact sur
la disponibilité du raid.</li>
<li>Prévu pour le futur avec des limites sur le nombre de fichiers, leur
taille maximale, la taille maximale du <code>zpool</code>...</li>
<li>La possibilité de créér des datasets (re)configurables contrairement
aux classiques <code>partitions</code>.</li>
<li>La possibilité de créér des snapshots sans coût, instantannés, et une
gestion très fine des données entre les snapshots.</li>
</ol>
<h2 id="mon-expérience-1"><a class="header" href="#mon-expérience-1">Mon expérience</a></h2>
<p>J'ai utilisé <code>ZFS</code> sur du perso dès 2009.<br />
Je l'ai utilisé sur de la prod dès 2012.</p>
<p>J'ai géré jusqu'à ~400 serveurs de prod avec du <code>ZFS on root</code>,
ce qui me permet d'être solide sur mon expérience avec ce système
de fichier, et donc, de <strong>savoir</strong> les gains qu'il apporte, les problèmes
qu'il permet d'<strong>éviter</strong>.</p>
<p>À ce jour (2025), mon PC perso est toujours sur <code>ZFS</code> → <a href="https://en.wikipedia.org/wiki/Eating_your_own_dog_food">Eat your own dog food</a>.</p>
<h2 id="sources"><a class="header" href="#sources">Sources</a></h2>
<ol>
<li><a href="https://fr.wikipedia.org/wiki/ZFS">ZFS - Wikipédia</a>.</li>
<li><a href="https://connect.ed-diamond.com/GNU-Linux-Magazine/glmf-114/zfs-sous-gnu-linux">GNU/Linux Magazine</a> - article de 2009, qui m'a lancé dans l'aventure <code>ZFS</code>.</li>
<li><a href="https://ikrima.dev/dev-notes/homelab/zfs-for-dummies/">ZFS for Dummies</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="les-cas-pratiques"><a class="header" href="#les-cas-pratiques">Les cas pratiques</a></h1>
<ul>
<li><a href="zfs/./datasets.html">Datasets</a></li>
<li><a href="zfs/./snapshots.html">Snapshots</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="datasets"><a class="header" href="#datasets">Datasets</a></h1>
<p>Les <code>datasets</code> sur <code>ZFS</code> sont des volumes qui sont créés sur un <code>zpool</code>
existant, et qui vont porter un ensemble de propriétées qui leur seront
propres ou héritées.</p>
<p>Chaque <code>dataset</code> est le fils d'un <code>dataset</code> ou directement du <code>zpool</code>.</p>
<p>Ce <code>dataset</code> sera mount comme un volume classique (par <code>ZFS</code>).</p>
<p>Les <code>datasets</code> peuvent être créés et détruits à tous moments.
Il est donc possible, en cas de nouveau besoin, d'adapter le système
de fichiers à celui-ci (par exemple un <code>dataset</code> par stack applicative
ou par utilisateur).</p>
<h2 id="pourquoi-cest-pratique"><a class="header" href="#pourquoi-cest-pratique">Pourquoi c'est pratique</a></h2>
<h3 id="réservation-disque"><a class="header" href="#réservation-disque">Réservation disque</a></h3>
<p>En configurant une réservation disque à l'avance, vous
pourrez vous assurer que cet espace lui soit dès le début
attribué, même s'il n'en fait pas l'usage immédiat.</p>
<p>C'est pour simplifier de la planification.</p>
<p>Exemple:</p>
<pre><code># zfs set reservation=5G zroot/root/home/web-user
</code></pre>
<pre><code># zfs list
NAME                        USED  AVAIL  REFER  MOUNTPOINT
zroot/root/home             5.00G  33.5G  8.50K  /home
zroot/root/home/web-user    15.0K  33.5G  8.50K  /home/web-user
</code></pre>
<p>L'espace est donc directement consommé sur <code>zroot/root/home</code> (qui est lui
aussi un <code>dataset</code>), même si <code>zroot/root/home/web-user</code> ne contient encore
aucunes données.</p>
<p>Sources:</p>
<ul>
<li><a href="https://docs.oracle.com/cd/E19253-01/819-5461/gbdbb/index.html">Setting Reservations on ZFS File Systems</a></li>
</ul>
<h3 id="configurer-un-quota"><a class="header" href="#configurer-un-quota">Configurer un quota</a></h3>
<p>Il est possible de définir un usage disque max sur un dataset.<br />
Sela permet d'empêcher une application, un utilisateur, ou un élément système
de consommer l'intégralité de l'espace du <code>zpool</code> en cas de défaut.</p>
<p>Le cas le plus classique étant la création de logs qui viennent saturer
le système.</p>
<p>Même si <code>journalctl</code> est configurable pour disposer d'une taille max des
logs, les applications n'utilisent pas toutes <code>journalctl</code>.</p>
<p>Exemple:</p>
<pre><code># zfs set quota=10G zroot/root/var/log
# zfs get quota zroot/root/var/log
NAME                PROPERTY  VALUE  SOURCE
zroot/root/var/log  quota     10G    local
</code></pre>
<p>Sources:</p>
<ul>
<li><a href="https://docs.oracle.com/cd/E23823_01/html/819-5461/gazvb.html">Setting ZFS Quotas and Reservations</a></li>
</ul>
<h3 id="compresser-les-données"><a class="header" href="#compresser-les-données">Compresser les données</a></h3>
<p>Si vous crééz un dataset dont vous savez à l'avance que les données
se compressent bien, alors vous pouvez activer.</p>
<p>Il est possible de choisir l'algorithme de compression, ainsi
qu'obtenir des stats sur son efficacité.</p>
<p>Il est évident que cela va surtout très bien s'appliquer pour
un <code>dataset</code> qui va contenir des logs.</p>
<p>Exemple:</p>
<pre><code># zfs set compression=on zroot/root/var/log
# zfs get compression zroot/root/var/log
NAME               PROPERTY     VALUE      SOURCE
zroot/root/var/log compression  on         local
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="snapshots"><a class="header" href="#snapshots">Snapshots</a></h1>
<p>Supposons un site web <code>PHP</code> classique avec une db <code>MariaDB</code> sous forme
de stack <code>docker compose</code>.<br />
Cette stack serait déclarée dans un dossier <code>/srv/docker/victim.org</code>.<br />
Le nom du dataset sera <code>zroot/srv/docker/victim.org</code>.</p>
<h2 id="création-dun-snapshot"><a class="header" href="#création-dun-snapshot">Création d'un snapshot</a></h2>
<pre><code class="language-bash">zfs snap zroot/srv/docker/victim.org@$(date +%Y-%m-%d-%H-%M-%S)
</code></pre>
<h2 id="liste-des-derniers-snapshots"><a class="header" href="#liste-des-derniers-snapshots">Liste des derniers snapshots</a></h2>
<pre><code>$  /s/d/victim.org  zfs list -H -rt snapshot -o name zroot/srv/docker/victim.org | tail -n5                                                                                                                                                                                                                                    4359ms  mar. 08 août 2023 16:14:41
zroot/srv/docker/victim.org@2023-08-04-00-00-08
zroot/srv/docker/victim.org@2023-08-05-00-00-13
zroot/srv/docker/victim.org@2023-08-06-00-00-04
zroot/srv/docker/victim.org@2023-08-07-00-00-04
zroot/srv/docker/victim.org@2023-08-08-00-00-06
</code></pre>
<h2 id="fichiers-modifiés-depuis-le-dernier-snapshot"><a class="header" href="#fichiers-modifiés-depuis-le-dernier-snapshot">Fichiers modifiés depuis le dernier snapshot</a></h2>
<pre><code>$  /s/d/victim.org  just diff                                                                                                                                                                                                                                                         mar. 08 août 2023 16:13:49
zfs diff $(zfs list -H -rt snapshot -o name zroot/srv/docker/victim.org | tail -n1)
M   /srv/docker/victim.org/db/ibdata1
M   /srv/docker/victim.org/db/ib_logfile0
M   /srv/docker/victim.org/db/ib_logfile1
M   /srv/docker/victim.org/db/victim/wp_options.ibd
M   /srv/docker/victim.org/code/wp-content
M   /srv/docker/victim.org/db/ibtmp1
+   /srv/docker/victim.org/backup/1691460000_2023-08-08_victim.sql
M   /srv/docker/victim.org/backup
</code></pre>
<h2 id="naviguer-dans-un-mount-du-snapshot"><a class="header" href="#naviguer-dans-un-mount-du-snapshot">Naviguer dans un mount du snapshot</a></h2>
<p>Pour voir le contenu du snapshot <code>2023-08-08-00-00-06</code> de notre stack,
nous pouvons aller dedans (<code>read-only</code>):</p>
<pre><code>cd /srv/docker/victim.org/.zfs/snapshots/2023-08-08-00-00-06
</code></pre>
<h2 id="rollback-la-stack-à-un-snapshot"><a class="header" href="#rollback-la-stack-à-un-snapshot">Rollback la stack à un snapshot</a></h2>
<pre><code>zfs rollback -r zroot/srv/docker/victim.org@2023-08-08-00-00-06
</code></pre>
<h2 id="exporter-la-stack"><a class="header" href="#exporter-la-stack">Exporter la stack</a></h2>
<p>Grâce à <code>zfs send</code>, il est possible d'exporter un <code>snapshot</code> comme bon
nous semble.</p>
<p>Si notre stack <code>docker compose</code> ne déclare que des volumes de type
<code>bind mount</code>, situés dans le même dossier, alors déplacer toute la stack
devient trivial!</p>
<p><code>zfs send</code> pourra être invoqué ainsi:</p>
<pre><code>zfs send zroot/srv/docker/victim.org@2023-08-08-00-00-06
</code></pre>
<p>Exporter en tant que fichier:</p>
<pre><code>zfs send zroot/srv/docker/victim.org@2023-08-08-00-00-06 &gt;/root/backup.victim.org.raw
</code></pre>
<p>Exporter via <code>SSH</code>:</p>
<pre><code>zfs send zroot/srv/docker/victim.org@2023-08-08-00-00-06 | ssh $host "zfs recv zroot/srv/docker/victim.org"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="outils"><a class="header" href="#outils">Outils</a></h1>
<h2 id="httm"><a class="header" href="#httm">httm</a></h2>
<p><a href="https://github.com/kimono-koans/httm">httm</a> permet de faciliter
l'utilisation de <code>zfs</code> pour avoir une visualisation de ce qui s'est passé
dans le temps, au niveau des datasets.</p>
<p>Parmis les différentes possibilitées, les 2 cas d'usage les plus basiques
sont ci dessous.</p>
<h3 id="trouver-les-versions-dun-fichier"><a class="header" href="#trouver-les-versions-dun-fichier">Trouver les versions d'un fichier</a></h3>
<p>Supposons notre stack <code>/srv/docker/victim.org</code> vue sur la page
<a href="zfs/snapshots.html">Snapshots</a>, pour visualiser toutes les modifications
de <code>docker-compose.yml</code> dans le temps, nous pouvons faire:</p>
<pre><code> $  /s/d/cloud.friloux.me  httm docker-compose.yml
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Sun Nov 02 17:04:30 2025 UTC  2.9 KiB  "/srv/docker/victim.org/.zfs/snapshot/zrepl_20251225_060837_000/docker-compose.yml"
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
Tue Dec 30 09:03:29 2025 UTC  2.9 KiB  "/srv/docker/victim.org/docker-compose.yml"
──────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
</code></pre>
<p>Et observer que ce fichier a été modifié depuis le dernier snapshot!</p>
<h3 id="trouver-les-fichiers-supprimés"><a class="header" href="#trouver-les-fichiers-supprimés">Trouver les fichiers supprimés</a></h3>
<p>Exemple avec une stack <a href="https://github.com/netdata/netdata">netdata</a>:</p>
<pre><code> $  /s/d/_base  httm -n --no-live -d -R . | head -n10
⠠
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000049.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000050.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000051.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000052.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000053.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000054.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000055.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000056.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-10-00-00-05/netdata/cache/dbengine-tier2/datafile-1-0000000057.ndf
/srv/docker/_base/.zfs/snapshot/2023-07-11-00-00-02/netdata/cache/dbengine-tier2/datafile-1-0000000057.ndf
</code></pre>
<h2 id="zfs-prune-snapshots"><a class="header" href="#zfs-prune-snapshots">zfs-prune-snapshots</a></h2>
<p><a href="https://github.com/bahamas10/zfs-prune-snapshots">zfs-prune-snapshots</a>
permet de gérer le nombre de snapshots à conserver.</p>
<h2 id="zrepl"><a class="header" href="#zrepl">zrepl</a></h2>
<p><a href="https://github.com/zrepl/zrepl">zrepl</a> permet de répliquer des datasets
entre plusieurs serveurs, que ce soit en mode <code>push</code> ou <code>pull</code>.</p>
<p>Même s'il peut être difficile de démarrer avec <code>zrepl</code> (j'ai trouvé
la documentation peu claire), le résultat est vraiment convaincant.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="nix"><a class="header" href="#nix">Nix</a></h1>
<h2 id="nix-1"><a class="header" href="#nix-1">Nix</a></h2>
<p><a href="https://nixos.org/">Nix</a> c'est:</p>
<ol>
<li>Un langage de programmation.</li>
<li>Un gestionnaire de packages.</li>
<li>Un système de build.</li>
</ol>
<p>Pour cela, il mobilise plusieurs concepts:</p>
<ol>
<li>C'est un langage de <a href="https://fr.wikipedia.org/wiki/Programmation_purement_fonctionnelle">programmation purement fonctionnel</a>.</li>
<li>Il est <a href="https://fr.wikipedia.org/wiki/Programmation_d%C3%A9clarative">déclaratif</a>.</li>
<li>Il est <a href="https://fr.wikipedia.org/wiki/%C3%89valuation_paresseuse">paresseux</a></li>
<li>Le résultat de son travail est <a href="https://en.wikipedia.org/wiki/Reproducible_builds">reproductible</a></li>
<li>Le résultat de son travail est <a href="https://fr.wikipedia.org/wiki/Portabilit%C3%A9_(informatique)">portable</a></li>
</ol>
<h2 id="nixos"><a class="header" href="#nixos">NixOS</a></h2>
<p><a href="https://nixos.org/">NixOS</a> c'est:</p>
<ol>
<li>Une distribution GNU/Linux initiée en 2006.</li>
<li>Une première version stable en 2013.</li>
<li>Un OS entièrement créé de manière <strong>déclarative</strong>, et <strong>reproductible</strong></li>
</ol>
<p><code>NixOS</code> est clairement un OVNI dans le monde <code>GNU/Linux</code>.<br />
Son seul concurrent dans son domaine est <a href="https://fr.wikipedia.org/wiki/GNU_Guix">GNU/Guix</a>.</p>
<h2 id="sources-1"><a class="header" href="#sources-1">Sources</a></h2>
<ul>
<li><a href="https://en.wikipedia.org/wiki/NixOS">NixOS - Wikipedia</a>.</li>
<li><a href="https://en.wikipedia.org/wiki/Nix_(package_manager)">Nix - Wikipedia</a>.</li>
<li><a href="https://blog.stephane-robert.info/docs/securiser/os-immuable/nixos/">NixOS : immuable et reproductible</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire-1"><a class="header" href="#histoire-1">Histoire</a></h1>
<p><code>Nix</code> est un projet démarré en 2003 par <code>Eelco Dolstra</code>,
qui prendra du temps à se mettre en place, car il bouscule tout l'existant.</p>
<ul>
<li><a href="https://edolstra.github.io/pubs/iscsd-scm11-final.pdf">Integrating Software Construction and Software Deployment</a> - 2003</li>
<li><a href="https://edolstra.github.io/pubs/nspfssd-lisa2004-final.pdf">Nix: A Safe and Policy-Free System for Software Deployment</a> - 2004</li>
<li><a href="https://edolstra.github.io/pubs/phd-thesis.pdf">The Purely Functional Software Deployment Model</a> - 2006</li>
</ul>
<h2 id="mon-expérience-2"><a class="header" href="#mon-expérience-2">Mon expérience</a></h2>
<p>Bien que j'ai pris connaissance de <code>NixOS</code> en 2017 via une
brève sur <a href="https://linuxfr.org/news/l-heure-du-test-episode-1-nixos">LinuxFR.org</a>,
mon intérêt était focalisé sur d'autres projets, et j'étais encore
bien trop lié à <a href="https://archlinux.fr/">Archlinux</a> (depuis 2008).</p>
<p>J'ai commencé <code>Nix</code> en 2023 via <a href="nix/devbox.html">Devbox</a>, qui a été convaincant,
ce que m'a motivé a essayer <a href="nix/home-manager.html">home-manager</a>.</p>
<p>1 an plus tard, je passai mon PC perso sous <code>NixOS</code> et commençait à écrire
des <a href="nix/flakes.html">flakes</a>.</p>
<p>Il me semble, à ce jour, que c'est un excellent moyen de s'embarquer dans
l'aventure <code>Nix</code>, par étapes.</p>
<h2 id="sources-2"><a class="header" href="#sources-2">Sources</a></h2>
<ul>
<li><a href="https://linuxfr.org/news/l-heure-du-test-episode-1-nixos">L'heure du test - épisode 1 - NixOS</a>.</li>
<li><a href="https://linuxfr.org/users/killruana/journaux/nixos-ou-comment-j-ai-rendu-mes-machines-interchangeables-et-ennuyeuses">Journal NixOS ou comment j'ai rendu mes machines interchangeables et ennuyeuses</a>.</li>
<li><a href="https://linuxfr.org/news/donnez-moi-un-nixos-a-ronger">Donnez moi un NixOS à ronger</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="devbox"><a class="header" href="#devbox">Devbox</a></h1>
<p><a href="https://www.jetify.com/devbox">Devbox</a> permet de créér des environnements
reproductibles entre différentes machines.</p>
<p>Ce projet se distingue des autres par son extrême simplicité:<br />
<strong>vous n'avez pas besoin de savoir utiliser <code>nix</code> pour utiliser <code>devbox</code></strong>.</p>
<p>Il s'agit d'une surcouche à <code>nix</code> et aux <code>flakes</code>, afin de rendre le tout
immédiatement utilisable pour créér des environnements de travail sur des
projets!</p>
<h2 id="exemple-ansible"><a class="header" href="#exemple-ansible">Exemple Ansible</a></h2>
<h3 id="en-local-sous-archlinux"><a class="header" href="#en-local-sous-archlinux">En local sous archlinux</a></h3>
<p>Depuis un PC sous <a href="https://archlinux.fr/">Archlinux</a> avec <code>nix</code> + <a href="https://www.jetify.com/devbox">Devbox</a>,
j'ai <code>ansible</code> qui a été installé depuis les packages <code>archlinux</code>:</p>
<pre><code class="language-bash"> kuri@Nomad  ansible  16:33  which ansible
/usr/sbin/ansible
 kuri@Nomad  ansible  16:33  ansible --version
ansible [core 2.20.0]
  config file = None
  configured module search path = ['/home/kuri/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /usr/lib/python3.13/site-packages/ansible
  ansible collection location = /home/kuri/.ansible/collections:/usr/share/ansible/collections
  executable location = /usr/sbin/ansible
  python version = 3.13.11 (main, Dec  7 2025, 13:01:45) [GCC 15.2.1 20251112] (/usr/bin/python)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
</code></pre>
<p>Nous avons <code>ansible</code> + <code>jinja</code> + <code>python</code> ainsi que diverses librairies
<code>python</code> afin que notre installation d'<code>ansible</code> soit fonctionnelle.</p>
<p>Pour cela, sous archlinux, j'ai fait <code>pacman -S ansible</code>.</p>
<h3 id="le-problème-cest-les-autres"><a class="header" href="#le-problème-cest-les-autres">Le problème c'est les autres</a></h3>
<p>Si j'ai 3 collègues, sous les OS suivants:</p>
<ol>
<li>Windows (WSL)</li>
<li>macOS</li>
<li>Ubuntu</li>
</ol>
<p>Je vais devoir leur dire de se débrouiller, pour voir comment installer
<code>ansible</code> sur leurs machines.</p>
<h3 id="la-solution-cest-devbox"><a class="header" href="#la-solution-cest-devbox">La solution c'est devbox</a></h3>
<p>Ou alors, je passe à la méthode <a href="https://www.jetify.com/devbox">Devbox</a>:</p>
<pre><code class="language-bash"> kuri@Nomad  ansible  16:35  devbox init
 kuri@Nomad  ansible  16:39  devbox add ansible
Info: Adding package "ansible@latest" to devbox.json
 kuri@Nomad  ansible  16:39  devbox shell
Info: Ensuring packages are installed.
✓ Computed the Devbox environment.
Starting a devbox shell...
Linux Nomad 6.17.9-arch1-1 x86_64
 16:40:06  up   8:34,  1 user,  load average: 0,38, 0,24, 0,28
(devbox)  kuri@Nomad  ansible  16:40  ansible --version
ansible [core 2.20.0]
  config file = None
  configured module search path = ['/home/kuri/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /nix/store/06p0i8w8zqrinjwldnypkva8s6ivz0r0-python3.13-ansible-core-2.20.0/lib/python3.13/site-packages/ansible
  ansible collection location = /home/kuri/.ansible/collections:/usr/share/ansible/collections
  executable location = /nix/store/06p0i8w8zqrinjwldnypkva8s6ivz0r0-python3.13-ansible-core-2.20.0/bin/ansible
  python version = 3.13.9 (main, Oct 14 2025, 13:52:31) [GCC 14.3.0] (/nix/store/3lll9y925zz9393sa59h653xik66srjb-python3-3.13.9/bin/python3.13)
  jinja version = 3.1.6
  pyyaml version = 6.0.3 (with libyaml v0.2.5)
</code></pre>
<p>Si ce dossier se trouve être un dépôt <code>git</code>, dans lequel je commit les fichiers
<code>devbox.{json,lock}</code>, tout personne qui le clone va travailler avec les mêmes
versions de packages que ceux définis dans <code>devbox.lock</code>.<br />
Et donc, à moins d'un bug spécifique à l'OS, tout le reste fonctionnera
à l'identique (y compris sous <code>ARM</code>).</p>
<h3 id="installer-ansible-core-216"><a class="header" href="#installer-ansible-core-216">Installer ansible-core 2.16</a></h3>
<p>Que ce soit via <code>devbox search ansible</code> ou <a href="https://www.nixhub.io/packages/ansible">Nixhub</a>,
je peux lister d'autres versions d'ansible disponibles.</p>
<p>Dans le cas de gestion de serveurs d'une autre époque (article écrit en décembre 2025), par exemple:</p>
<ol>
<li>CentOS 7</li>
<li>Amazon Linux 2</li>
<li>Debian 10</li>
</ol>
<p>La version <code>2.17</code> casse le support de ces versions, et nous devons donc utiliser la version
<code>2.16</code>, qui n'est globalement plus packagée.</p>
<p>Dans un monde ancien, nous aurions sous le coude une VM sous une version périmée
de <code>Debian</code> (genre la <code>10</code>), qui pointe sur le dépôt des archives, et qui aurait
<code>ansible 2.16</code> + toutes les deps à la bonne version, et on bichonnerait cette VM
comme le saint graal.</p>
<p>Ou, encore pire, on considère que des outils de gestion de config/conformité, c'est mal,
car les dernières versions ne supportent plus les dinos (le vrai problème
étant qu'on ne sait pas MAJ les serveurs).</p>
<p>Maintenant, réglons ce problème à la manière de <a href="https://www.jetify.com/devbox">Devbox</a>:</p>
<pre><code class="language-bash"> kuri@Nomad  ansible  17:22  devbox rm ansible
 kuri@Nomad  ansible  17:22  devbox add ansible@2.16.5
Info: Adding package "ansible@2.16.5" to devbox.json
Info: Installing the following packages to the nix store: ansible@2.16.5
 kuri@Nomad  ansible  17:23  devbox shell
Info: Ensuring packages are installed.
✓ Computed the Devbox environment.
Starting a devbox shell...
Linux Nomad 6.17.9-arch1-1 x86_64
 17:23:16  up   9:18,  1 user,  load average: 0,95, 0,50, 0,65
(devbox)  kuri@Nomad  ansible  17:23  ansible --version
ansible [core 2.16.5]
  config file = None
  configured module search path = ['/home/kuri/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']
  ansible python module location = /nix/store/a5k2lpbxj419kzn2pyz55gql35pbg8xx-python3.12-ansible-core-2.16.5/lib/python3.12/site-packages/ansible
  ansible collection location = /home/kuri/.ansible/collections:/usr/share/ansible/collections
  executable location = /nix/store/a5k2lpbxj419kzn2pyz55gql35pbg8xx-python3.12-ansible-core-2.16.5/bin/ansible
  python version = 3.12.4 (main, Jun  6 2024, 18:26:44) [GCC 13.3.0] (/nix/store/04gg5w1s662l329a8kh9xcwyp0k64v5a-python3-3.12.4/bin/python3.12)
  jinja version = 3.1.4
  libyaml = True
</code></pre>
<p>Que je sois sous <code>Archlinux</code>, <code>NixOS</code>, <code>Ubuntu</code>, <code>macOS</code>, <code>Windows</code>,
et peu importe les versions, tant que j'ai <code>devbox</code> (et donc <code>nix</code>),
j'ai cette reproductibilité sur des milliers de packages, ainsi que
les anciennes versions de ces packages, dans des envs isolé et
reproductibles!</p>
<h2 id="sources-3"><a class="header" href="#sources-3">Sources</a></h2>
<ul>
<li><a href="https://www.jetify.com/docs/devbox">What is Devbox?</a></li>
<li><a href="https://medium.com/vafion/devbox-a-user-friendly-approach-to-reproducible-development-environments-with-nix-83dbcd0ab8d8">Devbox: A User-Friendly Approach to Reproducible Development Environments with Nix</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="flakes"><a class="header" href="#flakes">flakes</a></h1>
<p>les <code>nix flakes</code> sont un moyen d'écrire des expressions <code>nix</code> dans
le but de:</p>
<ul>
<li>Packager un outil.</li>
<li>Créér une VM.</li>
<li>Installer/Configurer son système.</li>
<li>Installer/Configurer un système distant.</li>
<li>Créér un environnement de développement.</li>
</ul>
<p>Bien qu'extrêmement puissant, il s'agit d'un outil fort compliqué
à utiliser, car il requiert de savoir écrire dans le langage <code>nix</code>.</p>
<p>C'est pourquoi je ne recommande pas de se lancer dans l'aventure
<code>nix</code> en partant directement sur <code>nixos</code> + des <code>flakes</code> pour décrire
intégralement son OS et ses environnements de travail.</p>
<p>Il faut savoir s'approprier les outils par étapes, pour ne pas s'en
dégouter ou se dévaloriser suite à un effort trop complexe pour
être fait en une seule fois.</p>
<p><a href="nix/devbox.html">Devbox</a> est un moyen beaucoup plus rapide pour commencer
à créér des environnements de travail, tout en effectuant un premier
pas vers <code>nix</code>!</p>
<h2 id="modules"><a class="header" href="#modules">Modules</a></h2>
<p>Il est possible d'écrire des <code>flakes</code> sous forme de modules,
qui pourront être utilisés par d'autres <code>flakes</code>, afin de ne pas
toujours ré-inventer la roue.</p>
<h2 id="sources-4"><a class="header" href="#sources-4">Sources</a></h2>
<ul>
<li><a href="https://wiki.nixos.org/wiki/Flakes">Flakes - Official NixOS Wiki</a></li>
<li><a href="https://xeiaso.net/blog/paranoid-nixos-2021-07-18/">Paranoid NixOS Setup</a></li>
<li><a href="https://github.com/nix-community/impermanence">Nix Impermanence</a></li>
<li><a href="https://github.com/oddlama/nix-config/tree/main">oddlama/nix-config</a> - Exemple de
<code>flakes</code> pour gérer plusieurs hôtes sous <code>NixOS</code>.</li>
<li><a href="https://oblivion.keyruu.de/Homelab/NixOS-for-Servers">Is NixOS the best OS for servers?</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="direnv"><a class="header" href="#direnv">direnv</a></h1>
<p><a href="https://github.com/direnv/direnv">direnv</a> est un outil qui se greffe sur
votre shell afin de pouvoir automatiquement installer/charger des outils,
et executer des commandes, lorsque vous entrez dans un répertoire (<code>cd</code>).</p>
<p>Se reposant sur les gains que permet <code>nix</code> (et surtout les <a href="nix/flakes.html">flakes</a>), il permettra de configurer
automatiquement des envs de travail, en faisant au maximum abstraction
de l'OS que l'on utilise.</p>
<p>Sans avoir à connaitre par avance les spécificitées d'un projet
(ses dépendances), il sera possible de commencer à travailler dessus.</p>
<p>Exemples d'usages:</p>
<ul>
<li>Installer les outils <code>rust</code>+<code>cargo</code>+<code>cc</code> pour compiler un projet <code>rust</code>.</li>
<li>Installer <code>mdBooks</code> ou <code>mkdocs</code> pour build/visualiser de la documentation.</li>
<li>Installer les bonnes versions d'<code>ansible</code> ou <code>terraform</code> pour être
compatible avec les contraintes d'une infra.</li>
</ul>
<h2 id="sources-5"><a class="header" href="#sources-5">Sources</a></h2>
<ul>
<li><a href="https://direnv.net/">direnv.net</a>.</li>
<li><a href="https://determinate.systems/blog/nix-direnv/">Effortless dev environments with Nix and direnv</a>.</li>
<li><a href="https://nix.dev/guides/recipes/direnv.html">Automatic environment activation with direnv</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="home-manager"><a class="header" href="#home-manager">home-manager</a></h1>
<p><a href="https://github.com/nix-community/home-manager">home-manager</a>
est du code <code>nix</code> sous forme de <a href="nix/flakes.html">flakes</a> qui vont vous permettre
de gérer des environnements utilisateurs.</p>
<p>Classiquement, sous <code>GNU/Linux</code>, vous installez des outils au niveau
<code>système</code>, et tous ces outils sont disponibles à tous les utilisateurs.</p>
<p>Avec <code>home-manager</code>, vous allez pouvoir séparer les outils, c'est à dire
que vous continuerez d'avoir des outils disponibles au niveau <code>système</code>,
<strong>mais</strong> vous pourrez enrichir les environnements de certains utilisateurs.</p>
<p>l'idée est donc de garder la partie <code>système</code> la plus <strong>light possible</strong>,
et de seulement charger les utilisateurs qui ont besoins d'outils.</p>
<p>Il va aussi permettre de gérer les <a href="https://wiki.archlinux.org/title/Dotfiles">dotfiles</a>,
mais à un niveau inégalé par les différents outils de gestion de <a href="https://wiki.archlinux.org/title/Dotfiles">dotfiles</a>
existants.</p>
<p>Utilisateur <code>GNU/Linux</code> depuis 1997, le sujet des <a href="https://wiki.archlinux.org/title/Dotfiles">dotfiles</a>
d'une machine à l'autre, ou à force de réinstalls, je l'ai clairement poncé.</p>
<p>Absolument rien n'a été plus pratique que <a href="https://github.com/nix-community/home-manager">home-manager</a>
qui hérite des gains de <code>nix</code>, des <a href="nix/flakes.html">flakes</a>, et donc va non
seulement permettre d'installer des packages en espace utilisateur, mais
va créér des <strong>services systemd en espace utilisateur</strong>, et permettre de
<strong>générer les dotfiles</strong> de façon <strong>reproductible</strong> grâce à <code>nix</code>!</p>
<p><code>home-manager</code> est <code>Multi-OS</code>, je m'en suis d'abord servit sous <a href="https://archlinux.fr/">Archlinux</a>,
vous pouvez vous en servir sous <code>macOS</code>... Il n'est pas necessaire d'être sous <a href="https://nixos.org/">NixOS</a>.</p>
<h2 id="intégration-nix"><a class="header" href="#intégration-nix">Intégration nix</a></h2>
<p>Lorsque vous serez plus à l'aise avec <code>nix</code>, que vous en serez à gérer
des portions du système avec <code>nix</code>, ou bien tout simplement basculez
sur <code>NixOS</code>, vous pourrez intégrer vos configs <code>home-manager</code> dans vos
flakes.</p>
<p>Ce n'est donc pas une perte de temps de démarrer <code>nix</code> avec uniquement
<code>home-manager</code>.</p>
<h2 id="sources-6"><a class="header" href="#sources-6">Sources</a></h2>
<ul>
<li><a href="https://nix-community.github.io/home-manager/">Home Manager Manual</a>.</li>
<li><a href="https://ghedam.at/24353/tutorial-getting-started-with-home-manager-for-nix">Tutorial: Getting started with Home Manager for Nix</a>.</li>
<li><a href="https://github.com/Evertras/simple-homemanager">Evertras/simple-homemanager</a> A practical guide to getting
started with home manager with flakes and all that 2024 goodness.</li>
<li><a href="https://home-manager-options.extranix.com/">Home Manager - Option Search</a>.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="les-cas-pratiques-1"><a class="header" href="#les-cas-pratiques-1">Les cas pratiques</a></h1>
<ul>
<li><a href="nix/sshtui.html">sshtui</a> - Packager un script bash.</li>
<li><a href="nix/m365-refresh.html">m365-refresh</a> - Packager un service systemd en python (oneshot).</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sshtui"><a class="header" href="#sshtui">sshtui</a></h1>
<p><img src="https://github.com/gfriloux/sshtui/raw/main/sshtui.gif" alt="sshtui" /></p>
<p><a href="https://github.com/gfriloux/sshtui">sshtui</a> est un petit script qui permet de naviguer dans nos
configs <code>openssh</code> afin de trouver le serveur sur lequel on souhaite
se connecter.</p>
<p>Ses caractéristiques:</p>
<ul>
<li>Il se base sur <a href="https://github.com/alexpasmantier/television">tv</a> pour le rendu graphique.</li>
<li>Il créé un <a href="https://alexpasmantier.github.io/television/docs/Users/channels/">tv channel</a> pour permettre à <a href="https://github.com/alexpasmantier/television">tv</a> de savoir comment traiter
nos configs <code>openssh</code>.</li>
<li>Il dépend des outils suivants:
<ul>
<li><code>bash</code></li>
<li><code>bat</code></li>
<li><code>awk</code></li>
<li><code>xargs</code></li>
</ul>
</li>
</ul>
<p>Ses flakes déclarent un module pour <code>home-manager</code>, permettant de facilement
l'intégrer dans nos configurations <code>home-manager</code>.</p>
<p>C'est en fait un excellent projet pour apprendre à faire cela, car il a la
simplicité permettant de se focaliser sur comment intégrer dans <code>home-manager</code>
un package que l'on créé nous-même.</p>
<p>Afin encore d'éviter de se créér un ensemble de problèmes, nous allons utiliser
<a href="https://snowfall.org/guides/lib/quickstart/">snowfall-lib</a> qui "standardise" la manière d'écrire nos flakes, afin
qu'ils soient bien organisés (ce qui est très bien pour des débutants).</p>
<h2 id="création-de-notre-module-nix"><a class="header" href="#création-de-notre-module-nix">Création de notre module nix</a></h2>
<p>Dans cet exemple, nous crééons le dépôt <a href="https://github.com/gfriloux/sshtui">sshtui</a> sur <code>github</code>.</p>
<h3 id="flakenix"><a class="header" href="#flakenix">flake.nix</a></h3>
<p>dans notre <a href="https://github.com/gfriloux/sshtui/blob/c75e3449bd19c19b987154ae99a4e8d060547da4/flake.nix">flake.nix</a>, la partie importante est <a href="https://snowfall.org/guides/lib/quickstart/">celle-ci</a>:</p>
<pre><code class="language-nix">inputs.snowfall-lib.mkFlake {
  inherit inputs;
  systems = [ "x86_64-linux" "aarch64-linux" "x86_64-darwin" "aarch64-darwin" ];
  src = ./.;

  snowfall = {
    namespace = "sshtui";
  };
  alias = {
    packages.default = "sshtui";
  };
};
</code></pre>
<p>C'est ce qui va permette à <a href="https://snowfall.org/guides/lib/quickstart/">snowfall-lib</a> de générer tout le code du <code>flake</code>
avec les bons <code>output</code> pour réutiliser ce <code>module nix</code></p>
<h3 id="package-sshtui"><a class="header" href="#package-sshtui">package sshtui</a></h3>
<p>Nous pouvons dès maintenant déclarer notre package dans <code>packages/sshtui/default.nix</code>:</p>
<pre><code class="language-nix">{ lib, pkgs, writeShellApplication, ... }:

writeShellApplication {
  name = "sshtui";
  text = (builtins.readFile ../../sshtui);
  runtimeInputs = with pkgs; [
    bash
    television
    bat
    gawk       # awk
    findutils  # xargs
  ];

  meta  = with lib; {
    description = "Simple SSH TUI";
    licence = licences.gpl;
    platforms = platforms.all;
    mainProgram = "sshtui";
  };
}
</code></pre>
<p>C'est globalement aussi simple que ça!
Nous demandons à <code>nix</code> de build un script <code>shell</code> dont l'emplacement est à
la racine du projet : <a href="https://github.com/gfriloux/sshtui/blob/c75e3449bd19c19b987154ae99a4e8d060547da4/sshtui">../../sshtui</a></p>
<p>Et nous déclarons dans <code>runtimeInputs</code> les packages dont il dépend!
C'est tout!</p>
<h3 id="module-home-manager"><a class="header" href="#module-home-manager">module home-manager</a></h3>
<p>Afin de pouvoir utiliser ce <code>nix module</code> depuis <code>home-manager</code>,
nous avons besoin de déclarer <code>programs.sshtui</code> dans
<code>modules/home/sshtui/default.nix</code>:</p>
<pre><code class="language-nix">{ config, lib, pkgs, ... }:
let
  cfg = config.programs.sshtui;
in
{
  options.programs.sshtui = {
    enable = lib.mkEnableOption "sshtui";

    package = lib.mkOption {
      type = lib.types.package;
      default = pkgs.sshtui;
      description = "sshtui package to use";
    };
  };

  config = lib.mkIf cfg.enable {
    xdg.configFile."television/cable/sshtui.toml".source = ../../../sshtui.toml;
    home.packages = [
      cfg.package
    ];
  };
}
</code></pre>
<p>ainsi, si l'on déclare <code>programs.sshtui.enable=true;</code> dans notre config
<code>home-manager</code>, nous aurons:</p>
<ul>
<li>L'installation du script <code>sshtui</code>.</li>
<li>L'installation de <code>sshtui.toml</code> qui est notre <a href="https://alexpasmantier.github.io/television/docs/Users/channels/">tv channel</a> pour <a href="https://github.com/alexpasmantier/television">tv</a>.</li>
</ul>
<h3 id="overlay-sshtui"><a class="header" href="#overlay-sshtui">overlay sshtui</a></h3>
<p>Maintenant, pour que ce module s'intègre bien, nous allons déclarer un
<a href="https://snowfall.org/guides/lib/overlays/">snowfall-lib-overlay</a> afin de pouvoir utiliser <code>pkgs.sshtui</code>.<br />
On créé donc <code>overlays/sshtui/default.nix</code>:</p>
<pre><code class="language-nix">{ channels, inputs, ... }:

final: prev: {
  sshtui = inputs.self.packages.${final.system}.sshtui;
}
</code></pre>
<h2 id="utilisation-du-module"><a class="header" href="#utilisation-du-module">Utilisation du module</a></h2>
<p>Maintenant que tout est fait, pour l'utiliser il y'a 3 choses à faire
dans le dossier contenant nos flakes et notre config
<code>home-manager</code></p>
<h3 id="ajout-du-input-dans-flakenix"><a class="header" href="#ajout-du-input-dans-flakenix">Ajout du input dans flake.nix</a></h3>
<pre><code class="language-nix">sshtui = {
  url = "github:gfriloux/sshtui";
  inputs.nixpkgs.follows = "nixpkgs";
};
</code></pre>
<h3 id="déclaration-du-module-home-manager"><a class="header" href="#déclaration-du-module-home-manager">Déclaration du module home-manager</a></h3>
<p>Toujours dans <code>flake.nix</code> (normalement), sous
<code>home-manager.lib.homeManagerConfiguration</code>, nous
ajoutons ce <code>module</code>:</p>
<pre><code class="language-nix">modules = [
  sshtui.homeModules.sshtui
];
</code></pre>
<h3 id="installation-du-program"><a class="header" href="#installation-du-program">Installation du program</a></h3>
<p>Dans <code>home.nix</code> (normalement), nous
ajoutons:</p>
<pre><code class="language-nix">programs.sshtui.enable = true;
</code></pre>
<p>Et c'est tout!
Normalement vous devriez avoir la commande <code>sshtui</code> disponible!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="m365-refresh"><a class="header" href="#m365-refresh">m365-refresh</a></h1>
<p><a href="https://github.com/gfriloux/nix-m365">m365-refresh</a> est un script python qui permet de refresh
les {access,refresh} tokens pour l'auth <code>OAUTH2</code>, si vous avez
un compte mail chez microsoft.</p>
<p>C'est une reprise de <a href="https://github.com/UvA-FNWI/M365-IMAP">UvA-FNWI/M365-IMAP</a>, pour le faire
fonctionner en mode service.</p>
<p>Ce mini projet nous permet de facilement valider quelques technos:</p>
<ul>
<li>Packager un script python ultra basique.</li>
<li>Créér un service systemd dans votre espace utilisateur.</li>
<li>Créér un timer systemd dans votre espace utilisateur.</li>
</ul>
<h2 id="création-de-notre-module-nix-1"><a class="header" href="#création-de-notre-module-nix-1">Création de notre module nix</a></h2>
<h3 id="flakenix-1"><a class="header" href="#flakenix-1">flake.nix</a></h3>
<p>Notre <a href="https://github.com/gfriloux/nix-m365/blob/c4f523c05fb1e0ec99a0d1efc41b153fd23eca71/flake.nix">flake.nix</a> ne change pas vraiment par rapport à
<a href="nix/sshtui.nix">sshtui</a>:</p>
<pre><code class="language-nix">inputs.snowfall-lib.mkFlake {
  inherit inputs;
  systems = [ "x86_64-linux" "aarch64-linux" "x86_64-darwin" "aarch64-darwin" ];
  src = ./.;

  snowfall = {
    namespace = "m365";
  };
  alias = {
    packages.default = "m365";
  };
};
</code></pre>
<p>Le package s'appelle <code>m365</code> car à la base je pensai embarquer plusieurs
scripts, dont seul <code>m365-refresh.py</code> serait un service.</p>
<h3 id="packagesm365defaultnix"><a class="header" href="#packagesm365defaultnix">packages/m365/default.nix</a></h3>
<pre><code class="language-nix">{ lib, pkgs, python3Packages, ... }:

python3Packages.buildPythonApplication {
  pname = "m365";
  version = "1.0.0";
  src = ./src;

  propagatedBuildInputs = with python3Packages; [
    msal
  ];

  format = "other";

  installPhase = ''
    mkdir -p $out/bin
    install -m755 m365-refresh.py $out/bin/m365-refresh.py
  '';

  meta = with lib; {
    description = "Refresh oauth2 access token using MSAL";
    platforms = platforms.linux;
  };
}
</code></pre>
<p><code>buildPythonApplication</code> va s'occuper de créér un wrapper pour
surcharger le shebang du script, et bien être en isolation par
rapport au système.</p>
<p>Il va gérer l'installation du package python <code>msal</code>.</p>
<p>Le script python en lui-même : <a href="https://github.com/gfriloux/nix-m365/blob/c4f523c05fb1e0ec99a0d1efc41b153fd23eca71/packages/m365/src/m365-refresh.py">src/m365-refresh.py</a></p>
<h3 id="modulesm365defaultnix"><a class="header" href="#modulesm365defaultnix">modules/m365/default.nix</a></h3>
<pre><code class="language-nix">{ lib, config, pkgs, ...}:

let
  cfg = config.services.m365-refresh;
in
{
  options.services.m365-refresh = {
    enable = lib.mkEnableOption "m365 MSAL shit";
    schedule = lib.mkOption {
      type = lib.types.str;
      default = "hourly";
      description = "Systemd timer schedule";
    };
    config = lib.mkOption {
      type = lib.types.str;
      description = "path to configuration file";
    };
  };

  config = lib.mkIf cfg.enable {
  	systemd.user.services.m365-refresh = {
  	  Unit = {
  	  	Description = "m365 MSAL shit";
  	  };
  	  Service = {
  	  	Type = "oneshot";
  	    ExecStart = "${pkgs.m365}/bin/m365-refresh.py --config ${cfg.config}";
  	  };
  	};

  	systemd.user.timers.m365-refresh = {
  	  Unit = {
  	  	Description = "Timer for m365-refresh";
  	  };
  	  Timer = {
  	  	OnCalendar = cfg.schedule;
  	  	Persistent = true;
  	  };
  	  Install = {
  	  	WantedBy = [ "timers.target" ];
  	  };
  	};
  };
}
</code></pre>
<p>C'est ce module qui va nous permettre, dans notre config
<code>home-manager</code> de déclarer le service, avec la config
dont on a besoin <a href="https://github.com/UvA-FNWI/M365-IMAP/blob/main/config.py">config.py</a>.</p>
<p>Le bloc <code>options.services.m365-refresh</code> nous permet de définir
les options qui seront configuration dans notre config
<code>home-manager</code> (notamment l'emplacer du fichier <a href="https://github.com/UvA-FNWI/M365-IMAP/blob/main/config.py">config.py</a>).</p>
<p>Ensuite, il s'agit de la déclaration du service systemd et son
timer qui le déclenche.</p>
<h3 id="overlaysm365defaultnix"><a class="header" href="#overlaysm365defaultnix">overlays/m365/default.nix</a></h3>
<pre><code class="language-nix">{ channels, inputs, ... }:

final: prev: {
  m365 = inputs.self.packages.${final.system}.m365;
}
</code></pre>
<p>Cet overlay ne mérite pas vraiment d'attention, il nous permet juste
d'ajouter le package <code>m365</code> dans <code>pkgs</code>.</p>
<h2 id="utilisation-du-module-1"><a class="header" href="#utilisation-du-module-1">Utilisation du module</a></h2>
<h3 id="ajout-du-input-dans-flakenix-1"><a class="header" href="#ajout-du-input-dans-flakenix-1">Ajout du input dans flake.nix</a></h3>
<pre><code class="language-nix">sshtui = {
  url = "github:gfriloux/nix-m365";
  inputs.nixpkgs.follows = "nixpkgs";
};
</code></pre>
<h3 id="déclaration-du-module-home-manager-1"><a class="header" href="#déclaration-du-module-home-manager-1">Déclaration du module home-manager</a></h3>
<pre><code class="language-nix">modules = [
  nix-m365.homeModules.m365
];
</code></pre>
<h3 id="installation-du-service"><a class="header" href="#installation-du-service">Installation du service</a></h3>
<pre><code class="language-nix">services = {
  m365-refresh = {
    enable = true;
    schedule = "hourly";
    config = "/home/kuri/.config/m365/config.py";
  };
};
</code></pre>
<h2 id="vérification"><a class="header" href="#vérification">Vérification</a></h2>
<h3 id="service-systemd"><a class="header" href="#service-systemd">Service systemd</a></h3>
<pre><code> kuri@Nomad  ~  11:29  systemctl --user status m365-refresh
○ m365-refresh.service - m365 MSAL shit
     Loaded: loaded (/home/kuri/.config/systemd/user/m365-refresh.service; linked; preset: enabled)
     Active: inactive (dead) since Wed 2026-01-07 11:00:46 CET; 29min ago
 Invocation: 76d591c4f9cb4fd3b528e3de7b590869
TriggeredBy: ● m365-refresh.timer
    Process: 59019 ExecStart=/nix/store/i09rwnf3d1abavcmn0f4kz3gs5k370ax-m365-1.0.0/bin/m365-refresh.py --config /home/kuri/.config/m365/config.py (code=exited, status=0/SUCCESS)
   Main PID: 59019 (code=exited, status=0/SUCCESS)
   Mem peak: 49.1M
        CPU: 227ms

janv. 07 11:00:45 Nomad systemd[5477]: Starting m365 MSAL shit...
janv. 07 11:00:46 Nomad systemd[5477]: Finished m365 MSAL shit.
</code></pre>
<h3 id="timer-systemd"><a class="header" href="#timer-systemd">Timer systemd</a></h3>
<pre><code> kuri@Nomad  ~  11:29  systemctl --user list-timers
NEXT                         LEFT LAST                           PASSED UNIT               ACTIVATES           
Wed 2026-01-07 12:00:00 CET 29min Wed 2026-01-07 11:00:45 CET 29min ago m365-refresh.timer m365-refresh.service

1 timers listed.
Pass --all to see loaded but inactive timers, too.
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemd"><a class="header" href="#systemd">Systemd</a></h1>
<p><a href="https://systemd.io/">systemd</a> est un ensemble d'outils servant de
socle pour un système <code>GNU/Linux</code>.<br />
Il est aujourd'hui utilisé sur la plupart des distributions <code>GNU/Linux</code>.</p>
<p>Il est donc important de s'interesser a ses composants, dont l'un
des plus utilisé est <code>systemctl</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire-2"><a class="header" href="#histoire-2">Histoire</a></h1>
<p><code>Systemd</code> est un projet débuté en 2010.<br />
Il se pose alors en alternative à <a href="https://fr.wikipedia.org/wiki/UNIX_System_V">System V</a>, dont
il tente de résoudre les problèmes connus.</p>
<p>1 an après la première release, nous avons déjà un ensemble
de distributions qui basculent dessus, comme <code>Fedora</code> ou <code>Archlinux</code>.</p>
<p>Bien que <code>Systemd</code> soit fortement critiqué par un ensemble de personnes,
notamment sur son coté non <a href="https://fr.wikipedia.org/wiki/Principe_KISS">KISS</a>,
il faut reconnaitre qu'il a très rapidement été adopté sur la plupart des
distributions <code>GNU/Linux</code>.</p>
<h2 id="sources-7"><a class="header" href="#sources-7">Sources</a></h2>
<ul>
<li><a href="https://fr.wikipedia.org/wiki/Systemd">systemd - Wikipédia</a></li>
<li><a href="https://0pointer.de/blog/projects/the-biggest-myths.html">The Biggest Myths</a> (2013)</li>
<li><a href="https://linuxfr.org/news/systemd-l-init-martyrise-l-init-bafoue-mais-l-init-libere">systemd : l’init martyrisé, l’init bafoué, mais l’init libéré !</a> (2015)</li>
<li><a href="https://www.zdnet.fr/actualites/systemd-sur-debian-la-guerre-de-clochers-tourne-aux-menaces-39808179.htm">Systemd sur Debian : la guerre de clochers tourne aux menaces</a> (2014)</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="systemctl"><a class="header" href="#systemctl">systemctl</a></h1>
<p><a href="https://man7.org/linux/man-pages/man1/systemctl.1.html">systemctl</a> est le programme principal
de gestion de <a href="systemd/index.html">systemd</a>.</p>
<p>Nous n'allons globalement nous interesser qu'à la partie <code>gestion de services</code>.<br />
Il ne s'agit pas ici d'apprendre les bases, mais d'aller un peu plus loin.</p>
<h2 id="hardening-1"><a class="header" href="#hardening-1">Hardening</a></h2>
<h2 id="systemd-analyze-security"><a class="header" href="#systemd-analyze-security">systemd-analyze security</a></h2>
<p>Cette commande permet d'obtenir un score pour chaque service.<br />
L'idéal est de connaitre les besoins du service, et d'interdire tout
accès qui ne correspond pas aux besoins.</p>
<p>Il ne s'agit pas de restreindre le fonctionnement normal de l'application,
mais bien d'encadrer son exploitation ou un bug.</p>
<h2 id="configurations"><a class="header" href="#configurations">Configurations</a></h2>
<p>L'intérêt est donc pour chaque service que l'on déploie, d'ajouter
un <code>override</code> (par exemple via <code>systemctl edit</code>) qui va ajouter des restrictions.</p>
<p>Exemples:</p>
<ul>
<li><a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html?__goaway_challenge=meta-refresh&amp;__goaway_id=906c32ebcbcfadc50d8848f8da8a9896&amp;__goaway_referer=https%3A%2F%2Fwww.google.com%2F#PrivateTmp=">PrivateTmp=yes</a>: Créé un namespace pour que les accès du service dans <code>/tmp/</code> soient isolés dans un dossier temporaire.</li>
<li><a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html?__goaway_challenge=meta-refresh&amp;__goaway_id=906c32ebcbcfadc50d8848f8da8a9896&amp;__goaway_referer=https%3A%2F%2Fwww.google.com%2F#NoNewPrivileges=">NoNewPrivileges=true</a>: Permet d'empêcher le service d'obtenir de nouveaux privilèges.<br />
Par exemple pour empêcher <code>php-fpm</code> ou un de ses fils de pouvoir passer <code>root</code>.</li>
<li><a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html?__goaway_challenge=meta-refresh&amp;__goaway_id=906c32ebcbcfadc50d8848f8da8a9896&amp;__goaway_referer=https%3A%2F%2Fwww.google.com%2F#ProtectSystem=">ProtectSystem=strict</a>: Permet de passer tout <code>/</code> en <code>read-only</code>.<br />
Il convient ensuite d'utiliser <code>ReadWritePaths</code> pour autoriser les écritures dans certains dossiers.</li>
<li><a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html?__goaway_challenge=meta-refresh&amp;__goaway_id=906c32ebcbcfadc50d8848f8da8a9896&amp;__goaway_referer=https%3A%2F%2Fwww.google.com%2F#ReadWritePaths=">InaccessiblePaths</a>: Permet de rendre certains dossiers inaccessibles, y compris en lecture.</li>
</ul>
<h2 id="exemples-de-service"><a class="header" href="#exemples-de-service">Exemples de service</a></h2>
<p>Ces fichiers de configuration ont étés testés sur <code>Debian</code>.<br />
Ils ne sont pas parfaits, et doivent être adaptés à vos usages.</p>
<h3 id="redis"><a class="header" href="#redis">Redis</a></h3>
<p>Cette configuration permet d'obtenir un score de 2.5 sur <code>systemd-analyze security</code>.<br />
Il force l'utilisation des <a href="https://man7.org/linux/man-pages/man7/unix.7.html">sockets unix</a> (dans <code>/var/run/redis/</code>) pour la connexion,
au lieu de sockets tcp.</p>
<p><code>redis.conf</code>:</p>
<pre><code class="language-ini">[Service]
PrivateTmp=true
NoNewPrivileges=true
PrivateDevices=true
DevicePolicy=closed
ProtectSystem=strict
ProtectHome=true
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true
ProtectProc=invisible
RestrictNamespaces=true
RestrictRealtime=true
RestrictSUIDSGID=true
MemoryDenyWriteExecute=true
LockPersonality=true
ProtectClock=true
ProtectHostname=true
ProtectKernelLogs=true
PrivateUsers=true
RemoveIPC=true
CapabilityBoundingSet=~CAP_LINUX_IMMUTABLE CAP_IPC_LOCK CAP_SYS_CHROOT CAP_BLOCK_SUSPEND CAP_LEASE
ReadOnlyPaths=/
NoExecPaths=/
ExecPaths=-/usr/bin/redis-server
ExecPaths=-/usr/lib
ExecPaths=-/lib
ReadWritePaths=-/var/run/redis
ReadWritePaths=-/run/redis
ReadWritePaths=-/var/log/redis
ReadWritePaths=-/var/lib/redis
RestrictAddressFamilies=AF_UNIX
UMask=007
LimitNOFILE=65535
SystemCallArchitectures=native
SystemCallFilter=@system-service
SystemCallFilter=~ @privileged @resources
</code></pre>
<h3 id="mariadb"><a class="header" href="#mariadb">MariaDB</a></h3>
<p>Cette configuration permet d'obtenir un score de 4.5 sur <code>systemd-analyze security</code>.</p>
<p><code>mariadb.conf</code>:</p>
<pre><code class="language-ini">[Service]
PrivateTmp=true
NoNewPrivileges=true
PrivateDevices=true
DevicePolicy=closed
ProtectSystem=strict
ProtectHome=true
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true
ProtectProc=invisible
RestrictNamespaces=true
RestrictRealtime=true
RestrictSUIDSGID=true
MemoryDenyWriteExecute=true
LockPersonality=true
ProtectClock=true
ProtectHostname=true
ProtectKernelLogs=true
PrivateUsers=true
RemoveIPC=true
CapabilityBoundingSet=~CAP_LINUX_IMMUTABLE CAP_IPC_LOCK CAP_SYS_CHROOT CAP_BLOCK_SUSPEND CAP_LEASE
ReadOnlyPaths=/
NoExecPaths=/
ExecPaths=-/usr/sbin/mariadbd
ExecPaths=-/usr/lib
ExecPaths=-/lib
ReadWritePaths=-/var/run/mysqld
ReadWritePaths=-/run/mysqld
ReadWritePaths=-/var/lib/mysql/
RestrictAddressFamilies=AF_INET AF_INET6 AF_UNIX
UMask=007
LimitNOFILE=65535
SystemCallArchitectures=native

</code></pre>
<h3 id="php-fpm"><a class="header" href="#php-fpm">PHP-FPM</a></h3>
<p>Cette configuration permet d'obtenir un score de 4.6 sur <code>systemd-analyze security</code>.</p>
<p><code>php-fpm.conf</code>:</p>
<pre><code class="language-ini">[Service]
PrivateTmp=true
NoNewPrivileges=true
PrivateDevices=true
DevicePolicy=closed

# This option will make any JIT techniques to fail.
MemoryDenyWriteExecute=true

LockPersonality=true
UMask=007
LimitNOFILE=65535

RestrictNamespaces=~mnt
RestrictRealtime=true
RestrictSUIDSGID=true
RestrictAddressFamilies=AF_UNIX AF_NETLINK AF_INET AF_INET6

ProtectSystem=strict
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true
ProtectProc=invisible
ProtectClock=true
ProtectHostname=true
ProtectKernelLogs=true

SystemCallArchitectures=native
SystemCallErrorNumber=EPERM
SystemCallFilter=~@mount
SystemCallFilter=~@clock
SystemCallFilter=~@cpu-emulation
SystemCallFilter=~@module
SystemCallFilter=~@obsolete
SystemCallFilter=~@debug
SystemCallFilter=~@reboot

CapabilityBoundingSet=~CAP_SYS_PTRACE
CapabilityBoundingSet=~CAP_SYS_ADMIN
CapabilityBoundingSet=~CAP_MAC_*
CapabilityBoundingSet=~CAP_LINUX_IMMUTABLE
CapabilityBoundingSet=~CAP_SYS_BOOT
CapabilityBoundingSet=~CAP_SYS_CHROOT
CapabilityBoundingSet=~CAP_BLOCK_SUSPEND
CapabilityBoundingSet=~CAP_NET_ADMIN

ReadOnlyPaths=/

ReadWritePaths=-/var/log/alternatives.log
ReadWritePaths=-/var/lock
ReadWritePaths=-/run/php
ReadWritePaths=-/etc/alternatives
ReadWritePaths=-/var/lib/dpkg/alternatives
ReadWritePaths=-/var/log/php8.4-fpm.log
ReadWritePaths=-/var/www/html

NoExecPaths=/
ExecPaths=-/usr/sbin
ExecPaths=-/bin
ExecPaths=-/usr/bin
ExecPaths=-/usr/lib
ExecPaths=-/lib

InaccessiblePaths=-/boot
InaccessiblePaths=-/lost+found
InaccessiblePaths=-/etc/default
InaccessiblePaths=-/etc/apache2
InaccessiblePaths=-/etc/apt
InaccessiblePaths=-/etc/shadow
InaccessiblePaths=-/etc/sudoers
InaccessiblePaths=-/etc/sysctl.conf
InaccessiblePaths=-/etc/sysctl.d
InaccessiblePaths=-/var/backups
InaccessiblePaths=-/var/mail
InaccessiblePaths=-/var/spool
InaccessiblePaths=-/var/local
InaccessiblePaths=-/var/cache
InaccessiblePaths=-/var/opt
</code></pre>
<h3 id="apache2"><a class="header" href="#apache2">Apache2</a></h3>
<p>Cette configuration permet d'obtenir un score de 4.9 sur <code>systemd-analyze security</code>.</p>
<p><code>apache2.conf</code>:</p>
<pre><code class="language-ini">[Service]
PrivateTmp=true
NoNewPrivileges=true
PrivateDevices=true
DevicePolicy=closed
ProtectSystem=strict
ProtectControlGroups=true
ProtectKernelModules=true
ProtectKernelTunables=true
ProtectProc=invisible
RestrictNamespaces=true
RestrictRealtime=true
RestrictSUIDSGID=true
MemoryDenyWriteExecute=true
LockPersonality=true
ProtectClock=true
ProtectHostname=true
ProtectKernelLogs=true
ReadOnlyPaths=/
NoExecPaths=/
ExecPaths=-/usr/sbin
ExecPaths=-/bin
ExecPaths=-/usr/bin
ExecPaths=-/usr/local/bin
ExecPaths=-/usr/lib
ExecPaths=-/lib
ExecPaths=-/usr/lib/apache2/modules/
ReadWritePaths=-/var/log/apache2
ReadWritePaths=-/var/cache/apache2
ReadWritePaths=-/var/lib/apache2
ReadWritePaths=-/var/lock
ReadWritePaths=-/run/apache2
RestrictAddressFamilies=AF_UNIX AF_NETLINK AF_INET AF_INET6
UMask=007
LimitNOFILE=65535
SystemCallArchitectures=native
CapabilityBoundingSet=~CAP_SYS_PTRACE
</code></pre>
<h2 id="sources-8"><a class="header" href="#sources-8">Sources</a></h2>
<ul>
<li><a href="https://www.freedesktop.org/software/systemd/man/latest/systemd.exec.html">systemd.exec</a></li>
<li><a href="https://blog.stephane-robert.info/docs/admin-serveurs/linux/services/">Maitriser la gestion des services Linux avec systemd</a></li>
<li><a href="https://github.com/alegrey91/systemd-service-hardening">alegrey91/systemd-service-hardening</a></li>
<li><a href="https://nixos.wiki/wiki/Systemd_Hardening">Systemd Hardneing - NixOS Wiki</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="portable-services"><a class="header" href="#portable-services">portable services</a></h1>
<p>Depuis la <code>v239</code> (2018) de <a href="https://systemd.io/">Systemd</a>, est introduit la
notion de <a href="https://systemd.io/PORTABLE_SERVICES/">Portable Services</a>.</p>
<h2 id="en-quoi-cela-va-nous-interesser"><a class="header" href="#en-quoi-cela-va-nous-interesser">En quoi cela va nous interesser?</a></h2>
<h3 id="isolation"><a class="header" href="#isolation">Isolation</a></h3>
<ul>
<li>Si le service est compromis, les accès au système sont restreints.<br />
En effet, le service est chrooté dans son image.</li>
<li>Il est possible de donner accès à une partie du système de fichiers
du host via <code>BindPaths=</code> et <code>BindReadOnlyPaths=</code>, pour y stocker
des datas dites "dynamiques", ressemblant aux volumes sur <code>Docker</code>.<br />
Pour le reste, le service est <code>chroot</code>.</li>
<li>Pour les mises à jour, on <code>detach</code> l'image <code>.raw</code> de la version précédente
du service, et on <code>attach</code> la nouvelle version!<br />
C'est tout!<br />
Pas besoin de MAJ le système, votre démon est <strong>indépendant du
système sur lequel il s'execute!</strong>.
Vous pouvez MAJ le système sans impact sur le service, et inversement!</li>
</ul>
<p>Il va donc être possible d'avoir par exemple un dossier <code>/srv/startpage/</code>
contenant:</p>
<pre><code>.r--r--r-- root root 5.7 MB Thu Jan  1 01:00:01 1970  startpage_1.1.0.raw
.r--r--r-- root root 5.7 MB Thu Jan  1 01:00:01 1970  startpage_1.2.0.raw
.r--r--r-- root root 5.7 MB Thu Jan  1 01:00:01 1970  startpage_1.3.0.raw
</code></pre>
<p>et pouvoir upgrade le service dans le temps, et rollback sur l'image d'avant
en cas de problème.</p>
<h3 id="reproductibilité"><a class="header" href="#reproductibilité">Reproductibilité</a></h3>
<ul>
<li>On package notre démon dans une image <code>.raw</code>.
Cette image embarque le service et toutes ses dépendances.
Peu importe la distribution, il se comportera de la même manière.</li>
<li><a href="systemd/nix/index.html">Nix</a> sait construire des images <a href="https://systemd.io/PORTABLE_SERVICES/">Portable Services</a>
via <a href="https://ryantm.github.io/nixpkgs/builders/images/portableservice/#sec-pkgs-portableService">pkgs.portableService</a>.</li>
</ul>
<h3 id="léger"><a class="header" href="#léger">Léger</a></h3>
<ul>
<li>C'est plus léger que <code>docker</code> (pas de surcouche / isolation réseau).</li>
</ul>
<h2 id="pour-quelles-limites"><a class="header" href="#pour-quelles-limites">Pour quelles limites?</a></h2>
<p>Lorsque l'on commence à vouloir faire discuter plusieurs services,
<code>docker compose</code> (ou similaire) va s'imposer naturellement pour continuer
de bosser en <code>isolation</code>, avec <code>reproductibilité</code>.</p>
<h2 id="sources-9"><a class="header" href="#sources-9">Sources</a></h2>
<ul>
<li><a href="https://systemd.io/PORTABLE_SERVICES/">Systemd - Portable services</a></li>
<li><a href="https://0pointer.net/blog/walkthrough-for-portable-services.html">Walkthrough for Portable Services</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="les-cas-pratiques-2"><a class="header" href="#les-cas-pratiques-2">Les cas pratiques</a></h1>
<ul>
<li><a href="systemd/./startpage.html">startpage</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="startpage"><a class="header" href="#startpage">Startpage</a></h1>
<p><img src="systemd/startpage-preview-green.png" alt="startpage-preview-green" /></p>
<p><a href="https://github.com/gfriloux/retro-startpage">Ce projet</a> est un exemple de comment nous pouvons créér un <a href="systemd/portables.services.html">portable service</a>
très simple:</p>
<ul>
<li>Embarque un serveur web minimal (que l'on compile nous-même pour la demo).</li>
<li>Embarque le site web de la startpage.</li>
<li>Ajoute la database (<code>links.json</code>) des bookmarks.</li>
<li>Tout le service est isolé dans un fichier <code>.raw</code>.</li>
<li>Pas d'interactions avec d'autres services.</li>
<li>Pas de <code>BindPaths</code>.</li>
</ul>
<p>La construction de l'image se fait donc en 3 étapes:</p>
<ol>
<li>Packager <a href="https://github.com/gfriloux/littleweb">littleweb</a>.</li>
<li>Packager <a href="https://scar45.github.io/retro-crt-startpage/index.html">retro-crt-startpage</a>.</li>
<li>Packager le service file.</li>
</ol>
<h2 id="Étapes-de-construction"><a class="header" href="#Étapes-de-construction">Étapes de construction</a></h2>
<h3 id="littleweb"><a class="header" href="#littleweb">littleweb</a></h3>
<p>Projet <code>rust</code> utilisant <a href="https://actix.rs/">Actix Web</a> pour servir des
fichiers statiques.</p>
<p>A l'heure de l'écriture de cette page, le packaging de ce projet
(compilation d'un binaire statique) se fait dans ce bloc:</p>
<pre><code class="language-nix">littleweb = pkgs.rustPlatform.buildRustPackage (finalAttrs: {
  pname = "littleweb";
  version = "1.4.0";
  src = pkgs.fetchFromGitHub {
    owner = "gfriloux";
    repo = "littleweb";
    rev = "v1.4.0";
    sha256 = "sha256-Y2u2z/N73S5kJnsojNjY5OHTncZujyd8pLjcVSX/Cv4=";
  };
  cargoHash = "sha256-B9iAE5ua1I7kIfX9tBnnp2ewAs4j5oD8ttQqeorF5Xo=";
});
</code></pre>
<h3 id="retro-crt-startpage"><a class="header" href="#retro-crt-startpage">retro-crt-startpage</a></h3>
<p>La startpage <a href="https://scar45.github.io/retro-crt-startpage/index.html">retro-crt-startpage</a>
que l'on souhaite servir en <code>HTTP</code>.</p>
<p>Réalisé par ce simple bloc:</p>
<pre><code class="language-nix">website = pkgs.stdenv.mkDerivation rec {
  title = "retro-crt-startpage";
  description = "HTML5-based layout for a personalized retro CRT startpage.";
  name = "retro-crt-startpage";
  version = "1.3.1";
  src = pkgs.fetchzip {
    url = "https://github.com/scar45/retro-crt-startpage/releases/download/v1.3.1/retro-crt-startpage-v1.3.1-release.zip";
    hash = "sha256-UmYyfEy2BVMavAdEqlEYNT5A6dPXuxViAZ18n1fxCfc=";
  };
  nativebuildInputs = [ pkgs.zip ];
  installPhase = ''
    mkdir -p $out
    cp -r css fonts images js *.png *.html *.xml *.txt *.mp3 $out/
    cp ${./links.json} $out/links.json
  '';
};
</code></pre>
<p>On note que l'on ajoute notre fichier <code>links.json</code> local
au projet, qui n'en contient pas par défaut.</p>
<h3 id="portable-service"><a class="header" href="#portable-service">Portable service</a></h3>
<p>Construit l'image <code>.raw</code> compatible <a href="systemd/portables.services.html">portable service</a>.
Elle référence le package <code>unit</code> que je ne paste pas ici, il s'agit
du <code>service file</code> du service, que vous pouvez <a href="https://github.com/gfriloux/retro-startpage/blob/0176aa731b4606d5c9ad29a4f2b96f15fc69a0e6/flake.nix#L61">trouver ici</a>.</p>
<pre><code class="language-nix">oci-systemd = pkgs.portableService {
  pname = "retro-startpage";
  inherit ( packages.website ) version;
  units = [ packages.unit ];
  contents = with pkgs; [ packages.website ];
  homepage = "https://github.com/gfriloux/retro-startpage";
};
</code></pre>
<h2 id="construction-du-projet"><a class="header" href="#construction-du-projet">Construction du projet</a></h2>
<pre><code>nix build .#oci-systemd
</code></pre>
<h2 id="résultat"><a class="header" href="#résultat">Résultat</a></h2>
<p>Nous avons une image <code>retro-startpage_1.3.1.raw</code> de <code>4.9MB</code>.<br />
Le service consomme <code>~10MB</code> de RAM.
<code>systemd-analyze security</code> nous donne un score de <code>1.2</code>, ce qui est excellent.</p>
<p>Du fait d'utiliser <a href="https://github.com/gfriloux/littleweb">littleweb</a>,
que l'on compile <a href="https://en.wikipedia.org/wiki/Static_build">statiquement</a>,
nous avons une image type <a href="https://docs.docker.com/dhi/core-concepts/distroless/">distroless</a>,
<a href="https://wiki.archlinux.org/title/Chroot_(Fran%C3%A7ais)">chroot</a>,
avec du <a href="https://github.com/samderkaoui/systemd-service-hardening">systemd hardening</a>,
qu'il sera a priori très difficile d'exploiter!</p>
<p>Un seul binaire executable: <a href="https://github.com/gfriloux/littleweb">littleweb</a>.</p>
<p>En cas d'exploitation réussie, le service n'est pas <code>root</code>, n'accède pas
au système de fichiers de l'hôte, c'est une coquille vide...</p>
<p>Cette image est censée pouvoir s'executer sur toute distribution linux
disposant de <code>systemd v239</code> <code>x86_64</code>, c'est pas mal niveau portabilité!</p>
<p>Et biensûr, tout se passe dans <a href="https://github.com/gfriloux/retro-startpage/blob/main/flake.nix">flake.nix</a>!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="docker-1"><a class="header" href="#docker-1">Docker</a></h1>
<p><a href="https://www.docker.com/">Docker</a> est une solution de gestion de <code>conteneurs</code>.<br />
Il s'agit aujourd'hui de la solution dominante, car il est très
facile d'accès, un peu comme l'est <a href="docker/../nix/devbox.html">devbox</a> pour
créér des environnements de travail.</p>
<p><code>Docker</code> + <code>Docker Hub</code> permet de démarrer un service en mode
<code>conteneur</code> (donc avec de l'isolation réseau/process...) sans rien
connaitre des technologies sous-jacentes.</p>
<p>C'est ce qui a créé sa popularité, mais aussi les réactions d'une partie
du monde <code>IT</code> (reprochant l'usage "savant fou" rendu possible).</p>
<p>Il a aussi fait l'objet de critiques venant de "puristes" de types
d'installations plus traditionnelles, préférant utiliser les packages
système de leur distribution.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="histoire-3"><a class="header" href="#histoire-3">Histoire</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="traefik"><a class="header" href="#traefik">traefik</a></h1>
<p><a href="https://traefik.io/traefik">Traefik</a> est un proxy qui s'intègre très
bien à des stacks <code>docker</code> car il peut se configurer au travers
des <a href="https://docs.docker.com/engine/manage-resources/labels/">Docker labels</a>.</p>
<p>En effet, il est possible de déclarer un <code>vhost</code> au travers des
<a href="https://docs.docker.com/engine/manage-resources/labels/">Docker labels</a>
afin d'obtenir sa création et destruction selon si le conteneur associé
est démarré ou non.</p>
<p>Son autre usage le plus populaire est de l'utiliser pour générer des
certificats <a href="https://letsencrypt.org/fr/">Let's Encrypt</a> de manière automatisée
(et donc, toujours sur création du conteneur associé au vhost).</p>
<h2 id="routers"><a class="header" href="#routers">Routers</a></h2>
<p>Les <a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/routing/router/">routers</a>
nous permettent de décrire le traitement des requêtes, et donc, de définir
les <code>vhosts</code>.</p>
<p>Rien de très complexe, un <a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/routing/router/">routers</a>
<code>nextcloud</code> se déclarera ainsi:</p>
<pre><code class="language-toml">- traefik.http.routers.nextcloud.rule=Host(`nextcloud.victim.org`)
</code></pre>
<h2 id="middlewares"><a class="header" href="#middlewares">Middlewares</a></h2>
<p>Les <a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/middlewares/overview/">middlewares</a>
permettent de manipuler les requêtes et les réponses traitées.</p>
<h3 id="filtrage-ip"><a class="header" href="#filtrage-ip">Filtrage IP</a></h3>
<p>Nous pouvons déclarer le <a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/middlewares/overview/">middlewares</a>
<code>interne</code> suivant:</p>
<pre><code class="language-toml">labels:
  - "traefik.http.middlewares.interne.ipwhitelist.sourcerange=192.168.0.0/16"
</code></pre>
<p>Cela aura pour effet de filtrer les requêtes pour n'accepter que celles venant
du <code>CIDR</code> <code>192.168.0.0/16</code>.</p>
<p>Pour l'utiliser, il faut attacher ce <code>middleware</code> à notre <code>router</code> dédié
à notre conteneur <code>docker</code> (qui s'appelle <code>nextcloud</code> dans cet exemple):</p>
<pre><code class="language-toml">labels:
  - "traefik.http.routers.nextcloud.middlewares=interne"
</code></pre>
<p>Attention, ce filtrage cassera de fait la création de certificats
<a href="https://letsencrypt.org/fr/">Let's Encrypt</a>.<br />
Il conviendra donc de garder <code>/.well-known/</code> accessible publiquement,
par exemple en créant 2 <a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/routing/router/">router</a>
<code>nextcloud</code> et <code>nextcloud-le</code>:</p>
<pre><code class="language-toml">labels:
  - traefik.http.routers.nextcloud.rule=Host(`nextcloud.victim.org`)
  - traefik.http.routers.nextcloud.tls=true
  - traefik.http.routers.nextcloud.tls.certresolver=lets-encrypt
  - traefik.http.routers.nextcloud.middlewares=galilee-interne
  - traefik.http.routers.nextcloud-le.rule=(Host(`nextcloud.victim.org`) &amp;&amp; PathPrefix(`/.well-known/`))
  - traefik.http.routers.nextcloud-le.tls=true
  - traefik.http.routers.nextcloud-le.tls.certresolver=lets-encrypt
</code></pre>
<p>Ainsi, toute requête vers <code>nextcloud.victim.org/.well-known/</code> sera traitée par
le <a href="https://doc.traefik.io/traefik/reference/routing-configuration/http/routing/router/">router</a>
<code>interne-le</code>, sans restriction IP, alors que le reste y sera soumis.</p>
<h2 id="best-practices"><a class="header" href="#best-practices">Best practices</a></h2>
<h3 id="isoler-le-conteneur"><a class="header" href="#isoler-le-conteneur">Isoler le conteneur</a></h3>
<p>Le mieux est de pouvoir créér un ou plusieurs <a href="https://docs.docker.com/engine/network/">Docker network</a>
dont fera parti <a href="https://traefik.io/traefik">Traefik</a>.</p>
<p>Pour chaque conteneur qui aura effectivement besoin d'être proxifié par
<a href="https://traefik.io/traefik">Traefik</a>, il conviendra de l'associer à ce(s) network(s).</p>
<p>Le but étant, sur une stack <code>docker compose</code>, de n'avoir que ce conteneur
qui fasse parti du même <a href="https://docs.docker.com/engine/network/">Docker network</a>
que <a href="https://traefik.io/traefik">Traefik</a>, les autres n'étant donc pas directement
accessibles par <a href="https://traefik.io/traefik">Traefik</a>.</p>
<h2 id="sources-10"><a class="header" href="#sources-10">Sources</a></h2>
<ul>
<li><a href="https://blog.stephane-robert.info/docs/services/reseau/traefik/">Exposer des Services Web avec Traefik</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="watchtower"><a class="header" href="#watchtower">watchtower</a></h1>
<p><a href="https://github.com/containrrr/watchtower">Watchtower</a> est un outil de
gestion de mises à jour des conteneurs <code>docker</code>.</p>
<p>Je m'en sers depuis des années sans problèmes.</p>
<p>Il m'est notamment utile car si l'on spécifie des notifications
<code>mattermost</code>/<code>slack</code>, alors il va décrire ce qu'il fait.</p>
<h2 id="projet-archivé"><a class="header" href="#projet-archivé">Projet archivé</a></h2>
<p>Au moment de l'écriture de cette page, ils
<a href="https://github.com/containrrr/watchtower/discussions/2135">viennent d'annoncer l'abandon du projet</a>.</p>
<p>Plusieurs forks existent, dont
<a href="https://github.com/nicholas-fedor/watchtower">nicholas-fedor/watchtower</a> qui est activement
maintenu pour le moment, avec plus de 1000 commits ajoutés.</p>
<p>Donc à voir!</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="les-cas-pratiques-3"><a class="header" href="#les-cas-pratiques-3">Les cas pratiques</a></h1>
<ul>
<li><a href="docker/startpage.html">startpage</a> - Créér une image docker <code>distroless</code> de <a href="https://github.com/scar45/retro-crt-startpage">startpage</a></li>
<li><a href="docker/vaultwarden.html">vaultwarden</a> - Bien gérer notre fichier <code>docker-compose.yml</code></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="startpage-1"><a class="header" href="#startpage-1">startpage</a></h1>
<p><a href="https://github.com/gfriloux/retro-startpage">Startpage</a> est notre petit projet <code>demo</code> de création d'un site
web de gestion de bookmarks (statique).</p>
<p>Veuillez vous référer à <a href="docker/../systemd/startpage.html">systemd/startpage</a> pour comprendre
la stack.</p>
<p>En effet, ici, nous ne parlerons que de la création de l'image docker!</p>
<h2 id="construction-du-projet-1"><a class="header" href="#construction-du-projet-1">Construction du projet</a></h2>
<h3 id="nix-2"><a class="header" href="#nix-2">Nix</a></h3>
<p>Grâce à <code>nix</code>, nous allons pouvoir générer une image <a href="https://www.docker.com/">Docker</a>
la plus légère possible, sans fioritures, <a href="https://docs.docker.com/dhi/core-concepts/distroless/">distroless</a>.</p>
<p>Cela se fait en utilisant <a href="https://ryantm.github.io/nixpkgs/builders/images/dockertools/">pkgs.dockerTools</a>:</p>
<pre><code class="language-nix">oci-docker = pkgs.dockerTools.buildLayeredImage {
  name = "retro-startpage";
  tag = "latest";
  config = {
    Cmd = ["${packages.littleweb}/bin/littleweb" "--host" "0.0.0.0" "--path" "${packages.website}/"];
    User = "1000:1000";
  };
};
</code></pre>
<p>On lance le build:</p>
<pre><code>nix build .#oci-docker
</code></pre>
<h3 id="pourquoi-utiliser-nix"><a class="header" href="#pourquoi-utiliser-nix">Pourquoi utiliser nix?</a></h3>
<p>Tout simplement car en utilisant <code>nix</code> plutôt qu'écrire un <code>Dockerfile</code>,
nous ajoutons ses concepts, notamment, dans ce contexte:</p>
<ul>
<li>Les phases de build se font sans accès réseaux, il y'a
une phase de téléchargement des fichiers, une phase de construction.</li>
<li>Nous avons enfin des builds reproductibles, contrairement
à des <code>Dockerfile</code> qui cessent de build du jour au lendemain.</li>
</ul>
<p>Nous allons aussi éviter la facilité introduite par <a href="https://www.docker.com/">Docker</a>:</p>
<p>Écrire des <code>Dockerfile</code> avec <code>FROM debian</code> car c'est pratique, au cas où on
ait besoin d'un outil à un moment donné.<br />
Ça ne semble pas problèmatique si l'on n'y pense pas vraiment,
mais partir d'une distribution "de base", fait qu'on embarque un ensemble
de librairies, un shell, un package manager... qui pourront un jour jouer
contre notre service, en terme de sécurité (un shellcode de base execute
<code>/bin/sh</code>).</p>
<h2 id="résultat-1"><a class="header" href="#résultat-1">Résultat</a></h2>
<p>Nous pouvons charger l'image avec la commande <code>docker load &lt; result</code>.</p>
<h3 id="docker-images"><a class="header" href="#docker-images">docker images</a></h3>
<pre><code> kuri@Nomad  retro-startpage  main  16:02  docker images
IMAGE                    ID             DISK USAGE   CONTENT SIZE   EXTRA
retro-startpage:latest   1df45e5206f5       13.2MB             0B
</code></pre>
<h3 id="dive"><a class="header" href="#dive">dive</a></h3>
<p><a href="https://github.com/wagoodman/dive">dive</a> nous permet d'inspecter
le contenu de notre image, afin de vérifier que nous avons bien
quelque chose de léger, <a href="https://docs.docker.com/dhi/core-concepts/distroless/">distroless</a>:</p>
<pre><code>┃ ● Current Layer Contents ┣━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
Permission     UID:GID       Size  Filetree                                                                                                                    
drwxr-xr-x   1000:1000      13 MB  └── nix                                                                                                                     
drwxr-xr-x   1000:1000      13 MB      └── store                                                                                                               
dr-xr-xr-x   1000:1000     9.9 MB          ├── mk1nrzsfngfj5hipmgq1a51cysr89x43-littleweb-static-x86_64-unknown-linux-musl-1.4.0                               
dr-xr-xr-x   1000:1000     9.9 MB          │   └── bin                                                                                                         
-r-xr-xr-x   1000:1000     9.9 MB          │       └── littleweb                                                                                               
dr-xr-xr-x   1000:1000     3.2 MB          └── nga39cm902ckqjwffp8r2f63kkb72jbc-retro-crt-startpage-x86_64-unknown-linux-musl                                  
-r--r--r--   1000:1000      33 kB              ├── apple-touch-icon.png                                                                                        
-r--r--r--   1000:1000     8.7 kB              ├── ascii-headers.html                                                                                          
-r--r--r--   1000:1000      445 B              ├── browserconfig.xml                                                                                           
-r--r--r--   1000:1000      611 B              ├── crossdomain.xml                                                                                             
dr-xr-xr-x   1000:1000      23 kB              ├─⊕ css                                                                                                         
-r--r--r--   1000:1000      33 kB              ├── favicon.png                                                                                                 
dr-xr-xr-x   1000:1000     398 kB              ├─⊕ fonts                                                                                                       
-r--r--r--   1000:1000      229 B              ├── humans.txt                                                                                                  
dr-xr-xr-x   1000:1000     2.4 MB              ├─⊕ images                                                                                                      
-r--r--r--   1000:1000     3.3 kB              ├── index.html                                                                                                  
dr-xr-xr-x   1000:1000     264 kB              ├─⊕ js                                                                                                          
-r--r--r--   1000:1000     2.0 kB              ├── links.json                                                                                                  
-r--r--r--   1000:1000      23 kB              ├── power_off.mp3                                                                                               
-r--r--r--   1000:1000      35 kB              ├── power_on.mp3                                                                                                
-r--r--r--   1000:1000       61 B              └── robots.txt          
</code></pre>
<h3 id="docker-run"><a class="header" href="#docker-run">docker run</a></h3>
<pre><code> kuri@Nomad  retro-startpage  main  16:07  docker run -p 80:8080 retro-startpage
[2025-12-29T15:07:16Z INFO  littleweb] Serving /nix/store/nga39cm902ckqjwffp8r2f63kkb72jbc-retro-crt-startpage-x86_64-unknown-linux-musl/ on port 8080
[2025-12-29T15:07:16Z INFO  actix_server::builder] starting 2 workers
[2025-12-29T15:07:16Z INFO  actix_server::server] Actix runtime found; starting in Actix runtime
[2025-12-29T15:07:16Z INFO  actix_server::server] starting service: "actix-web-service-0.0.0.0:8080", workers: 2, listening on: 0.0.0.0:8080
</code></pre>
<p>Il est désormais possible d'accéder au service via <a href="http://localhost:80">http://localhost:80</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vaultwarden"><a class="header" href="#vaultwarden">vaultwarden</a></h1>
<p><a href="https://github.com/dani-garcia/vaultwarden">Vaultwarden</a> est une
implémentation libre du serveur de <a href="https://bitwarden.com">Bitwarden</a>.</p>
<p>Nous allons discuter de comment nous implémentons ce service
dans un écosystème disposant de <a href="docker/traefik.html">traefik</a> et
<a href="docker/watchertower.html">watchtower</a>.</p>
<p>Pas de <code>nixfection</code> (pour le moment!).</p>
<h2 id="séparation-des-déclarations"><a class="header" href="#séparation-des-déclarations">Séparation des déclarations</a></h2>
<p>Bien que cela semble ridicule pour cet exemple du fait que
la stack soit très légère, cela nous permet justement de mieux
appréhender le concept.</p>
<p>Sur une infra plus complexe, nous y trouverions aussi <code>MariaDB</code>, <code>Redis</code>...</p>
<h3 id="docker-composeyml"><a class="header" href="#docker-composeyml">docker-compose.yml</a></h3>
<p>Dans <code>docker-compose.yml</code> nous n'allons déclarer que les éléments essentiels
à la gestion de la stack.</p>
<p>Ce fichier pourrait tout simplement être donné à un client,
un collègue...<br />
A l'inverse, il peut vous être fourni par les développeurs de l'application,
et vous le gardez inchangé pour mieux voir les diffs dans le temps
(pour certains projets, votre stack est un <code>git clone</code> d'un dépôt,
et donc vous ne souhaitez pas créér de diff sur ce fichier indexé
par <code>git</code>).</p>
<p>Il ne contient rien de spécifique.</p>
<pre><code class="language-yml">services:
  bitwarden:
    image: vaultwarden/server:latest
    restart: always
    environment:
      - EXPERIMENTAL_CLIENT_FEATURE_FLAGS=ssh-key-vault-item,ssh-agent
    volumes:
      - ./data:/data
</code></pre>
<h3 id="docker-composeoverrideyml"><a class="header" href="#docker-composeoverrideyml">docker-compose.override.yml</a></h3>
<p>Dans <code>docker-compose.override.yml</code> nous allons écrire les spécifités
de notre stack, notamment:</p>
<ul>
<li>Notre conteneur doit être sur le réseau <code>web</code> (dans lequel nous avons
notre <a href="docker/traefik.html">traefik</a>).</li>
<li>Notre conteneur est mis à jour par <a href="docker/watchtower.html">watchtower</a> avec
les règles par défaut.</li>
<li>Notre conteneur dispose de labels pour <a href="docker/traefik.html">traefik</a> afin
de déclarer le <code>vhost</code> et gérer automatiquement le certificat
<code>Let's Encrypt</code>.</li>
</ul>
<pre><code class="language-yml">services:
  bitwarden:
    labels:
      - traefik.http.routers.vaultwarden.rule=Host(`vaultwarden.victim.org`)
      - traefik.http.routers.vaultwarden.tls=true
      - traefik.http.routers.vaultwarden.tls.certresolver=lets-encrypt
      - com.centurylinklabs.watchtower.enable=true
    networks:
      - web

networks:
  web:
    external: true
</code></pre>
<p>Rien à faire pour que <code>Docker</code> prenne en compte ce fichier, vous
pouvez directement utiliser <code>docker compose up -d</code>.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
